var Wt=Object.create;var at=Object.defineProperty;var Kt=Object.getOwnPropertyDescriptor;var qt=Object.getOwnPropertyNames;var jt=Object.getPrototypeOf,Jt=Object.prototype.hasOwnProperty;var it=(e=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(e,{get:(t,r)=>(typeof require<"u"?require:t)[r]}):e)(function(e){if(typeof require<"u")return require.apply(this,arguments);throw Error('Dynamic require of "'+e+'" is not supported')});var Qt=(e,t)=>()=>(t||e((t={exports:{}}).exports,t),t.exports);var Zt=(e,t,r,a)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of qt(t))!Jt.call(e,i)&&i!==r&&at(e,i,{get:()=>t[i],enumerable:!(a=Kt(t,i))||a.enumerable});return e};var er=(e,t,r)=>(r=e!=null?Wt(jt(e)):{},Zt(t||!e||!e.__esModule?at(r,"default",{value:e,enumerable:!0}):r,e));var ct=Qt((Io,ft)=>{var ye;typeof window<"u"?ye=window:typeof global<"u"?ye=global:typeof self<"u"?ye=self:ye={};ft.exports=ye});var D={};(function(){function e(o){if(o=o||[0,97,115,109,1,0,0,0],typeof WebAssembly!="object"||typeof WebAssembly.instantiate!="function")return!1;try{var o=new WebAssembly.Module(new Uint8Array(o));if(o instanceof WebAssembly.Module)return new WebAssembly.Instance(o)instanceof WebAssembly.Instance}catch{}return!1}function t(){try{var o=new WebAssembly.Memory({initial:1,maximum:1,shared:!0});return o.buffer instanceof SharedArrayBuffer}catch{}return!1}var r=typeof process<"u";D.base||(D.base=import.meta.url,D.base=D.base.replace(/\/[^\/]*$/,"")),D.isWebAssemblySupported=e,D.isThreadingSupported=t;function a(o){o=o||{};var s=!o.nowasm&&e(),u=o.yesthreads&&s&&!o.nothreads&&t();return s?u?"thr":"wasm":"asm"}D.target=a,D.VER="6.5.7.1",D.CONFIG="h264-aac-mp3",D.DBG="",D.factories={};var i={};i.i64tof64=function(o,s){return!s&&o>=0||s===-1&&o<0?o:s*4294967296+o+(o<0?4294967296:0)},i.f64toi64=function(o){return[~~o,Math.floor(o/4294967296)]},i.i64ToBigInt=function(o,s){var u=new DataView(new ArrayBuffer(8));return u.setInt32(0,o,!0),u.setInt32(4,s,!0),u.getBigInt64(0,!0)},i.bigIntToi64=function(o){var s=new DataView(new ArrayBuffer(8));return s.setBigInt64(0,o,!0),[s.getInt32(0,!0),s.getInt32(4,!0)]},i.ff_channel_layout=function(o){return o.channel_layout?o.channel_layout:o.channels&&o.channels!==1?(1<<o.channels)-1:4},i.ff_channels=function(o){if(o.channels)return o.channels;if(o.channel_layout){for(var s=0,u=o.channel_layout;u;)s+=u&1,u>>=1;return s}else return 1};function n(o,s){typeof s===void 0&&(s=0);var u=s;o.forEach((function(l){i[l]=u++}))}i.AV_TIME_BASE=1e6,i.AV_OPT_SEARCH_CHILDREN=1,n(["AVMEDIA_TYPE_UNKNOWN","AVMEDIA_TYPE_VIDEO","AVMEDIA_TYPE_AUDIO","AVMEDIA_TYPE_DATA","AVMEDIA_TYPE_SUBTITLE","AVMEDIA_TYPE_ATTACHMENT"],-1),n(["AV_SAMPLE_FMT_NONE","AV_SAMPLE_FMT_U8","AV_SAMPLE_FMT_S16","AV_SAMPLE_FMT_S32","AV_SAMPLE_FMT_FLT","AV_SAMPLE_FMT_DBL","AV_SAMPLE_FMT_U8P","AV_SAMPLE_FMT_S16P","AV_SAMPLE_FMT_S32P","AV_SAMPLE_FMT_FLTP","AV_SAMPLE_FMT_DBLP","AV_SAMPLE_FMT_S64","AV_SAMPLE_FMT_S64P","AV_SAMPLE_FMT_NB"],-1),n(["AV_PIX_FMT_NONE","AV_PIX_FMT_YUV420P","AV_PIX_FMT_YUYV422","AV_PIX_FMT_RGB24","AV_PIX_FMT_BGR24","AV_PIX_FMT_YUV422P","AV_PIX_FMT_YUV444P","AV_PIX_FMT_YUV410P","AV_PIX_FMT_YUV411P","AV_PIX_FMT_GRAY8","AV_PIX_FMT_MONOWHITE","AV_PIX_FMT_MONOBLACK","AV_PIX_FMT_PAL8","AV_PIX_FMT_YUVJ420P","AV_PIX_FMT_YUVJ422P","AV_PIX_FMT_YUVJ444P","AV_PIX_FMT_UYVY422","AV_PIX_FMT_UYYVYY411","AV_PIX_FMT_BGR8","AV_PIX_FMT_BGR4","AV_PIX_FMT_BGR4_BYTE","AV_PIX_FMT_RGB8","AV_PIX_FMT_RGB4","AV_PIX_FMT_RGB4_BYTE","AV_PIX_FMT_NV12","AV_PIX_FMT_NV21","AV_PIX_FMT_ARGB","AV_PIX_FMT_RGBA","AV_PIX_FMT_ABGR","AV_PIX_FMT_BGRA","AV_PIX_FMT_GRAY16BE","AV_PIX_FMT_GRAY16LE","AV_PIX_FMT_YUV440P","AV_PIX_FMT_YUVJ440P","AV_PIX_FMT_YUVA420P","AV_PIX_FMT_RGB48BE","AV_PIX_FMT_RGB48LE","AV_PIX_FMT_RGB565BE","AV_PIX_FMT_RGB565LE","AV_PIX_FMT_RGB555BE","AV_PIX_FMT_RGB555LE","AV_PIX_FMT_BGR565BE","AV_PIX_FMT_BGR565LE","AV_PIX_FMT_BGR555BE","AV_PIX_FMT_BGR555LE"],-1),i.AVIO_FLAG_READ=1,i.AVIO_FLAG_WRITE=2,i.AVIO_FLAG_READ_WRITE=3,i.AVIO_FLAG_NONBLOCK=8,i.AVIO_FLAG_DIRECT=32768,i.AVFMT_FLAG_NOBUFFER=64,i.AVFMT_FLAG_FLUSH_PACKETS=512,i.AVSEEK_FLAG_BACKWARD=1,i.AVSEEK_FLAG_BYTE=2,i.AVSEEK_FLAG_ANY=4,i.AVSEEK_FLAG_FRAME=8,i.AVDISCARD_NONE=-16,i.AVDISCARD_DEFAULT=0,i.AVDISCARD_NONREF=8,i.AVDISCARD_BIDIR=16,i.AVDISCARD_NONINTRA=24,i.AVDISCARD_NONKEY=32,i.AVDISCARD_ALL=48,i.AV_LOG_QUIET=-8,i.AV_LOG_PANIC=0,i.AV_LOG_FATAL=8,i.AV_LOG_ERROR=16,i.AV_LOG_WARNING=24,i.AV_LOG_INFO=32,i.AV_LOG_VERBOSE=40,i.AV_LOG_DEBUG=48,i.AV_LOG_TRACE=56,i.AV_PKT_FLAG_KEY=1,i.AV_PKT_FLAG_CORRUPT=2,i.AV_PKT_FLAG_DISCARD=4,i.AV_PKT_FLAG_TRUSTED=8,i.AV_PKT_FLAG_DISPOSABLE=16,n(["E2BIG","EPERM","EADDRINUSE","EADDRNOTAVAIL","EAFNOSUPPORT","EAGAIN","EALREADY","EBADF","EBADMSG","EBUSY","ECANCELED","ECHILD","ECONNABORTED","ECONNREFUSED","ECONNRESET","EDEADLOCK","EDESTADDRREQ","EDOM","EDQUOT","EEXIST","EFAULT","EFBIG","EHOSTUNREACH","EIDRM","EILSEQ","EINPROGRESS","EINTR","EINVAL","EIO","EISCONN","EISDIR","ELOOP","EMFILE","EMLINK","EMSGSIZE","EMULTIHOP","ENAMETOOLONG","ENETDOWN","ENETRESET","ENETUNREACH","ENFILE","ENOBUFS","ENODEV","ENOENT"],1),i.AVERROR_EOF=-541478725,Object.assign(D,i),D.LibAV=function(o){o=o||{};var s=o.base||D.base,u=a(o),l="h264-aac-mp3";u==="asm"&&(l=o.variant||D.variant||"h264-aac-mp3");var d=!0;d&&(o.noes6||D.noes6)&&(d=!1);var p=o.toImport||D.toImport||s+"/libav-6.5.7.1-"+l+"."+u+"."+(d?"mjs":"js"),f,y="direct";return u==="thr"?y="threads":!r&&!o.noworker&&typeof Worker<"u"&&(y="worker"),Promise.all([]).then((function(){if(o.factory||D.factory)return o.factory||D.factory;if(D.factories[p])return D.factories[p];if(y!=="worker")return d?import(p).then((function(A){return D.factories[p]=A.default,A.default})):r?D.factories[p]=it(p):typeof importScripts<"u"?(importScripts(p),D.factories[p]=LibAVFactory):new Promise((function(A,_){var w=document.createElement("script");w.src=p,w.addEventListener("load",A),w.addEventListener("error",_),w.async=!0,document.body.appendChild(w)})).then((function(){return D.factories[p]=LibAVFactory}))})).then((function(A){return y==="worker"?(f={},f.worker=new Worker(p,{type:d?"module":"classic"}),f.worker.postMessage({config:{variant:o.variant||D.variant,wasmurl:o.wasmurl||D.wasmurl}}),new Promise((function(_,w){f.on=1,f.handlers={onready:[function(){_()},null],onwrite:[function(m){f.onwrite&&f.onwrite.apply(f,m)},null],onread:[function(m){try{var c=null;f.onread&&(c=f.onread.apply(f,m)),c&&c.then&&c.catch&&c.catch((function(h){f.ff_reader_dev_send(m[0],null,{error:h})}))}catch(h){f.ff_reader_dev_send(m[0],null,{error:h})}},null],onblockread:[function(m){try{var c=null;f.onblockread&&(c=f.onblockread.apply(f,m)),c&&c.then&&c.catch&&c.catch((function(h){f.ff_block_reader_dev_send(m[0],m[1],null,{error:h})}))}catch(h){f.ff_block_reader_dev_send(m[0],m[1],null,{error:h})}},null]},f.c=function(){for(var m=Array.prototype.slice.call(arguments),c=[],h=0;h<m.length;h++)m[h]&&m[h].libavjsTransfer&&c.push.apply(c,m[h].libavjsTransfer);return new Promise((function(x,T){var V=f.on++;m=[V].concat(m),f.handlers[V]=[x,T],f.worker.postMessage(m,c)}))};function E(m){var c=m.data[0],h=f.handlers[c];h&&(m.data[2]?h[0](m.data[3]):h[1](m.data[3]),typeof c=="number"&&delete f.handlers[c])}f.worker.onmessage=E,f.terminate=function(){f.worker.terminate()}}))):y==="threads"?Promise.all([]).then((function(){return A({wasmurl:o.wasmurl||D.wasmurl,variant:o.variant||D.variant})})).then((function(_){f=_;var w=f.libavjs_create_main_thread(),E=f.PThread.pthreads[w],m=0,c=1,h={},x=null,T=new Promise((function(b){x=b}));f.c=function(){var b=Array.prototype.slice.call(arguments);return new Promise((function(L,$){var M=c++;b=[M].concat(b),h[M]=[L,$],E.postMessage({c:"libavjs_run",a:b})}))};var V=E.onmessage;return E.onmessage=function(b){if(b.data&&b.data.c==="libavjs_ret"){var L=b.data.a,$=h[L[0]];$&&(L[2]?$[0](L[3]):$[1](L[3]),delete h[L[0]])}else if(b.data&&b.data.c==="libavjs_wait_reader")if(f.readerDevReady(b.data.fd))E.postMessage({c:"libavjs_wait_reader",fd:b.data.fd});else{var M=f.fdName(b.data.fd),I=f.ff_reader_dev_waiters[M];I||(I=f.ff_reader_dev_waiters[M]=[]),I.push((function(){E.postMessage({c:"libavjs_wait_reader",fd:b.data.fd})}))}else if(b.data&&b.data.c==="libavjs_ready")x();else return V.apply(this,arguments)},f.terminate=function(){f.PThread.unusedWorkers.concat(f.PThread.runningWorkers).forEach((function(b){b.terminate()}))},T})):Promise.all([]).then((function(){return A({wasmurl:o.wasmurl||D.wasmurl,variant:o.variant||D.variant})})).then((function(_){f=_,f.worker=!1,f.c=function(w){var E=Array.prototype.slice.call(arguments,1);return new Promise((function(m,c){try{m(f[w].apply(f,E))}catch(h){c(h)}}))},f.terminate=function(){}}))})).then((function(){function A(m){m.forEach((function(c){f[c]=function(){return f.c.apply(f,[c].concat(Array.prototype.slice.call(arguments)))}}))}function _(m){m.forEach((function(c){var h=f[c+"_sync"]=f[c];f[c]=function(){var x=arguments;return new Promise((function(T,V){try{var b=h.apply(f,x);typeof b=="object"&&b!==null&&b.then?b.then(T).catch(V):T(b)}catch(L){V(L)}}))}}))}var w=["av_get_bytes_per_sample","av_compare_ts_js","av_opt_set","av_opt_set_int_list_js","av_frame_alloc","av_frame_clone","av_frame_free","av_frame_get_buffer","av_frame_make_writable","av_frame_ref","av_frame_unref","ff_frame_rescale_ts_js","av_log_get_level","av_log_set_level","av_packet_alloc","av_packet_clone","av_packet_free","av_packet_new_side_data","av_packet_ref","av_packet_rescale_ts_js","av_packet_unref","av_strdup","av_buffersink_get_frame","av_buffersink_get_time_base_num","av_buffersink_get_time_base_den","av_buffersink_set_frame_size","ff_buffersink_set_ch_layout","av_buffersrc_add_frame_flags","avfilter_free","avfilter_get_by_name","avfilter_graph_alloc","avfilter_graph_config","avfilter_graph_create_filter_js","avfilter_graph_free","avfilter_graph_parse","avfilter_inout_alloc","avfilter_inout_free","avfilter_link","avcodec_alloc_context3","avcodec_close","avcodec_descriptor_get","avcodec_descriptor_get_by_name","avcodec_descriptor_next","avcodec_find_decoder","avcodec_find_decoder_by_name","avcodec_find_encoder","avcodec_find_encoder_by_name","avcodec_flush_buffers","avcodec_free_context","avcodec_get_name","avcodec_open2","avcodec_open2_js","avcodec_parameters_alloc","avcodec_parameters_copy","avcodec_parameters_free","avcodec_parameters_from_context","avcodec_parameters_to_context","avcodec_receive_frame","avcodec_receive_packet","avcodec_send_frame","avcodec_send_packet","av_find_input_format","avformat_alloc_context","avformat_alloc_output_context2_js","avformat_close_input","avformat_find_stream_info","avformat_flush","avformat_free_context","avformat_new_stream","avformat_open_input","avformat_open_input_js","av_seek_frame","avformat_seek_file","avformat_seek_file_min","avformat_seek_file_max","avformat_seek_file_approx","avformat_write_header","avio_open2_js","avio_close","avio_flush","av_find_best_stream","av_get_sample_fmt_name","av_grow_packet","av_interleaved_write_frame","av_packet_make_writable","av_pix_fmt_desc_get","av_read_frame","av_shrink_packet","av_write_frame","av_write_trailer","av_dict_copy_js","av_dict_free","av_dict_set_js","sws_getContext","sws_freeContext","sws_scale_frame","AVPacketSideData_data","AVPacketSideData_size","AVPacketSideData_type","AVPixFmtDescriptor_comp_depth","ff_error","ff_nothing","calloc","close","dup2","free","malloc","mallinfo_uordblks","open","strerror","libavjs_with_swscale","libavjs_create_main_thread","ffmpeg_main","ffprobe_main","ffmpeg_interrupt","ffmpeg_get_out_time_ms","ffmpeg_get_total_size_bytes","AVFrame_channel_layout","AVFrame_channel_layout_s","AVFrame_channel_layouthi","AVFrame_channel_layouthi_s","AVFrame_channels","AVFrame_channels_s","AVFrame_channel_layoutmask","AVFrame_channel_layoutmask_s","AVFrame_ch_layout_nb_channels","AVFrame_ch_layout_nb_channels_s","AVFrame_crop_bottom","AVFrame_crop_bottom_s","AVFrame_crop_left","AVFrame_crop_left_s","AVFrame_crop_right","AVFrame_crop_right_s","AVFrame_crop_top","AVFrame_crop_top_s","AVFrame_data_a","AVFrame_data_a_s","AVFrame_format","AVFrame_format_s","AVFrame_height","AVFrame_height_s","AVFrame_key_frame","AVFrame_key_frame_s","AVFrame_linesize_a","AVFrame_linesize_a_s","AVFrame_nb_samples","AVFrame_nb_samples_s","AVFrame_pict_type","AVFrame_pict_type_s","AVFrame_pts","AVFrame_pts_s","AVFrame_ptshi","AVFrame_ptshi_s","AVFrame_sample_aspect_ratio_num","AVFrame_sample_aspect_ratio_num_s","AVFrame_sample_aspect_ratio_den","AVFrame_sample_aspect_ratio_den_s","AVFrame_sample_aspect_ratio_s","AVFrame_sample_rate","AVFrame_sample_rate_s","AVFrame_time_base_num","AVFrame_time_base_num_s","AVFrame_time_base_den","AVFrame_time_base_den_s","AVFrame_time_base_s","AVFrame_width","AVFrame_width_s","AVPixFmtDescriptor_flags","AVPixFmtDescriptor_flags_s","AVPixFmtDescriptor_log2_chroma_h","AVPixFmtDescriptor_log2_chroma_h_s","AVPixFmtDescriptor_log2_chroma_w","AVPixFmtDescriptor_log2_chroma_w_s","AVPixFmtDescriptor_nb_components","AVPixFmtDescriptor_nb_components_s","AVCodec_name","AVCodec_sample_fmts","AVCodec_sample_fmts_s","AVCodec_sample_fmts_a","AVCodec_sample_fmts_a_s","AVCodec_supported_samplerates","AVCodec_supported_samplerates_s","AVCodec_supported_samplerates_a","AVCodec_supported_samplerates_a_s","AVCodec_type","AVCodec_type_s","AVCodecContext_codec_id","AVCodecContext_codec_id_s","AVCodecContext_codec_type","AVCodecContext_codec_type_s","AVCodecContext_bit_rate","AVCodecContext_bit_rate_s","AVCodecContext_bit_ratehi","AVCodecContext_bit_ratehi_s","AVCodecContext_channel_layout","AVCodecContext_channel_layout_s","AVCodecContext_channel_layouthi","AVCodecContext_channel_layouthi_s","AVCodecContext_channels","AVCodecContext_channels_s","AVCodecContext_channel_layoutmask","AVCodecContext_channel_layoutmask_s","AVCodecContext_ch_layout_nb_channels","AVCodecContext_ch_layout_nb_channels_s","AVCodecContext_extradata","AVCodecContext_extradata_s","AVCodecContext_extradata_size","AVCodecContext_extradata_size_s","AVCodecContext_frame_size","AVCodecContext_frame_size_s","AVCodecContext_framerate_num","AVCodecContext_framerate_num_s","AVCodecContext_framerate_den","AVCodecContext_framerate_den_s","AVCodecContext_framerate_s","AVCodecContext_gop_size","AVCodecContext_gop_size_s","AVCodecContext_height","AVCodecContext_height_s","AVCodecContext_keyint_min","AVCodecContext_keyint_min_s","AVCodecContext_level","AVCodecContext_level_s","AVCodecContext_max_b_frames","AVCodecContext_max_b_frames_s","AVCodecContext_pix_fmt","AVCodecContext_pix_fmt_s","AVCodecContext_profile","AVCodecContext_profile_s","AVCodecContext_rc_max_rate","AVCodecContext_rc_max_rate_s","AVCodecContext_rc_max_ratehi","AVCodecContext_rc_max_ratehi_s","AVCodecContext_rc_min_rate","AVCodecContext_rc_min_rate_s","AVCodecContext_rc_min_ratehi","AVCodecContext_rc_min_ratehi_s","AVCodecContext_sample_aspect_ratio_num","AVCodecContext_sample_aspect_ratio_num_s","AVCodecContext_sample_aspect_ratio_den","AVCodecContext_sample_aspect_ratio_den_s","AVCodecContext_sample_aspect_ratio_s","AVCodecContext_sample_fmt","AVCodecContext_sample_fmt_s","AVCodecContext_sample_rate","AVCodecContext_sample_rate_s","AVCodecContext_time_base_num","AVCodecContext_time_base_num_s","AVCodecContext_time_base_den","AVCodecContext_time_base_den_s","AVCodecContext_time_base_s","AVCodecContext_qmax","AVCodecContext_qmax_s","AVCodecContext_qmin","AVCodecContext_qmin_s","AVCodecContext_width","AVCodecContext_width_s","AVCodecDescriptor_id","AVCodecDescriptor_id_s","AVCodecDescriptor_long_name","AVCodecDescriptor_long_name_s","AVCodecDescriptor_mime_types_a","AVCodecDescriptor_mime_types_a_s","AVCodecDescriptor_name","AVCodecDescriptor_name_s","AVCodecDescriptor_props","AVCodecDescriptor_props_s","AVCodecDescriptor_type","AVCodecDescriptor_type_s","AVCodecParameters_bit_rate","AVCodecParameters_bit_rate_s","AVCodecParameters_channel_layoutmask","AVCodecParameters_channel_layoutmask_s","AVCodecParameters_channels","AVCodecParameters_channels_s","AVCodecParameters_ch_layout_nb_channels","AVCodecParameters_ch_layout_nb_channels_s","AVCodecParameters_chroma_location","AVCodecParameters_chroma_location_s","AVCodecParameters_codec_id","AVCodecParameters_codec_id_s","AVCodecParameters_codec_tag","AVCodecParameters_codec_tag_s","AVCodecParameters_codec_type","AVCodecParameters_codec_type_s","AVCodecParameters_color_primaries","AVCodecParameters_color_primaries_s","AVCodecParameters_color_range","AVCodecParameters_color_range_s","AVCodecParameters_color_space","AVCodecParameters_color_space_s","AVCodecParameters_color_trc","AVCodecParameters_color_trc_s","AVCodecParameters_extradata","AVCodecParameters_extradata_s","AVCodecParameters_extradata_size","AVCodecParameters_extradata_size_s","AVCodecParameters_format","AVCodecParameters_format_s","AVCodecParameters_framerate_num","AVCodecParameters_framerate_num_s","AVCodecParameters_framerate_den","AVCodecParameters_framerate_den_s","AVCodecParameters_framerate_s","AVCodecParameters_height","AVCodecParameters_height_s","AVCodecParameters_level","AVCodecParameters_level_s","AVCodecParameters_profile","AVCodecParameters_profile_s","AVCodecParameters_sample_rate","AVCodecParameters_sample_rate_s","AVCodecParameters_width","AVCodecParameters_width_s","AVPacket_data","AVPacket_data_s","AVPacket_dts","AVPacket_dts_s","AVPacket_dtshi","AVPacket_dtshi_s","AVPacket_duration","AVPacket_duration_s","AVPacket_durationhi","AVPacket_durationhi_s","AVPacket_flags","AVPacket_flags_s","AVPacket_pos","AVPacket_pos_s","AVPacket_poshi","AVPacket_poshi_s","AVPacket_pts","AVPacket_pts_s","AVPacket_ptshi","AVPacket_ptshi_s","AVPacket_side_data","AVPacket_side_data_s","AVPacket_side_data_elems","AVPacket_side_data_elems_s","AVPacket_size","AVPacket_size_s","AVPacket_stream_index","AVPacket_stream_index_s","AVPacket_time_base_num","AVPacket_time_base_num_s","AVPacket_time_base_den","AVPacket_time_base_den_s","AVPacket_time_base_s","AVFormatContext_duration","AVFormatContext_duration_s","AVFormatContext_durationhi","AVFormatContext_durationhi_s","AVFormatContext_flags","AVFormatContext_flags_s","AVFormatContext_nb_streams","AVFormatContext_nb_streams_s","AVFormatContext_oformat","AVFormatContext_oformat_s","AVFormatContext_pb","AVFormatContext_pb_s","AVFormatContext_start_time","AVFormatContext_start_time_s","AVFormatContext_start_timehi","AVFormatContext_start_timehi_s","AVFormatContext_streams_a","AVFormatContext_streams_a_s","AVStream_codecpar","AVStream_codecpar_s","AVStream_discard","AVStream_discard_s","AVStream_duration","AVStream_duration_s","AVStream_durationhi","AVStream_durationhi_s","AVStream_time_base_num","AVStream_time_base_num_s","AVStream_time_base_den","AVStream_time_base_den_s","AVStream_time_base_s","AVFilterInOut_filter_ctx","AVFilterInOut_filter_ctx_s","AVFilterInOut_name","AVFilterInOut_name_s","AVFilterInOut_next","AVFilterInOut_next_s","AVFilterInOut_pad_idx","AVFilterInOut_pad_idx_s","ff_init_encoder","ff_init_decoder","ff_free_encoder","ff_free_decoder","ff_encode_multi","ff_decode_multi","ff_set_packet","ff_init_muxer","ff_free_muxer","ff_init_demuxer_file","ff_write_multi","ff_read_frame_multi","ff_read_multi","ff_init_filter_graph","ff_filter_multi","ff_decode_filter_multi","ff_copyout_frame","ff_copyout_frame_video","ff_frame_video_packed_size","ff_copyout_frame_video_packed","ff_copyout_frame_video_imagedata","ff_copyout_frame_ptr","ff_copyin_frame","ff_copyout_packet","ff_copyout_packet_ptr","ff_copyin_packet","ff_copyout_codecpar","ff_copyin_codecpar","ff_malloc_int32_list","ff_malloc_int64_list","ffmpeg","ffprobe","av_frame_free_js","av_packet_free_js","avformat_close_input_js","avcodec_free_context_js","avcodec_parameters_free_js","avfilter_graph_free_js","avfilter_inout_free_js","av_dict_free_js"],E=["readFile","writeFile","unlink","unmount","mkdev","createLazyFile","mkreaderdev","mkblockreaderdev","mkreadaheadfile","unlinkreadaheadfile","mkwriterdev","mkstreamwriterdev","mountwriterfs","mkfsfhfile","unlinkfsfhfile","mkworkerfsfile","unlinkworkerfsfile","ff_reader_dev_send","ff_block_reader_dev_send","ff_reader_dev_waiting","copyin_u8","copyout_u8","copyin_s16","copyout_s16","copyin_s32","copyout_s32","copyin_f32","copyout_f32"];return f.libavjsMode=y,y==="worker"?(A(w),A(E)):y==="threads"?(A(w),_(E)):(_(w),_(E)),Object.assign(f,i),f}))}})();var{base:Lr,isWebAssemblySupported:Ur,isThreadingSupported:Xr,target:Br,VER:Gr,CONFIG:Yr,DBG:$r,factories:zr,i64tof64:Hr,f64toi64:Wr,i64ToBigInt:Kr,bigIntToi64:qr,ff_channel_layout:jr,ff_channels:Jr,AV_TIME_BASE:Qr,AV_OPT_SEARCH_CHILDREN:Zr,AVMEDIA_TYPE_UNKNOWN:ea,AVMEDIA_TYPE_VIDEO:ta,AVMEDIA_TYPE_AUDIO:ra,AVMEDIA_TYPE_DATA:aa,AVMEDIA_TYPE_SUBTITLE:ia,AVMEDIA_TYPE_ATTACHMENT:na,AV_SAMPLE_FMT_NONE:oa,AV_SAMPLE_FMT_U8:sa,AV_SAMPLE_FMT_S16:_a,AV_SAMPLE_FMT_S32:la,AV_SAMPLE_FMT_FLT:ua,AV_SAMPLE_FMT_DBL:da,AV_SAMPLE_FMT_U8P:fa,AV_SAMPLE_FMT_S16P:ca,AV_SAMPLE_FMT_S32P:ma,AV_SAMPLE_FMT_FLTP:pa,AV_SAMPLE_FMT_DBLP:Aa,AV_SAMPLE_FMT_S64:ha,AV_SAMPLE_FMT_S64P:ga,AV_SAMPLE_FMT_NB:ya,AV_PIX_FMT_NONE:Ea,AV_PIX_FMT_YUV420P:wa,AV_PIX_FMT_YUYV422:ba,AV_PIX_FMT_RGB24:va,AV_PIX_FMT_BGR24:Ta,AV_PIX_FMT_YUV422P:Sa,AV_PIX_FMT_YUV444P:Va,AV_PIX_FMT_YUV410P:Da,AV_PIX_FMT_YUV411P:Pa,AV_PIX_FMT_GRAY8:Ia,AV_PIX_FMT_MONOWHITE:Ra,AV_PIX_FMT_MONOBLACK:xa,AV_PIX_FMT_PAL8:Ma,AV_PIX_FMT_YUVJ420P:Fa,AV_PIX_FMT_YUVJ422P:Oa,AV_PIX_FMT_YUVJ444P:Ca,AV_PIX_FMT_UYVY422:ka,AV_PIX_FMT_UYYVYY411:Na,AV_PIX_FMT_BGR8:La,AV_PIX_FMT_BGR4:Ua,AV_PIX_FMT_BGR4_BYTE:Xa,AV_PIX_FMT_RGB8:Ba,AV_PIX_FMT_RGB4:Ga,AV_PIX_FMT_RGB4_BYTE:Ya,AV_PIX_FMT_NV12:$a,AV_PIX_FMT_NV21:za,AV_PIX_FMT_ARGB:Ha,AV_PIX_FMT_RGBA:Wa,AV_PIX_FMT_ABGR:Ka,AV_PIX_FMT_BGRA:qa,AV_PIX_FMT_GRAY16BE:ja,AV_PIX_FMT_GRAY16LE:Ja,AV_PIX_FMT_YUV440P:Qa,AV_PIX_FMT_YUVJ440P:Za,AV_PIX_FMT_YUVA420P:ei,AV_PIX_FMT_RGB48BE:ti,AV_PIX_FMT_RGB48LE:ri,AV_PIX_FMT_RGB565BE:ai,AV_PIX_FMT_RGB565LE:ii,AV_PIX_FMT_RGB555BE:ni,AV_PIX_FMT_RGB555LE:oi,AV_PIX_FMT_BGR565BE:si,AV_PIX_FMT_BGR565LE:_i,AV_PIX_FMT_BGR555BE:li,AV_PIX_FMT_BGR555LE:ui,AVIO_FLAG_READ:di,AVIO_FLAG_WRITE:fi,AVIO_FLAG_READ_WRITE:ci,AVIO_FLAG_NONBLOCK:mi,AVIO_FLAG_DIRECT:pi,AVFMT_FLAG_NOBUFFER:Ai,AVFMT_FLAG_FLUSH_PACKETS:hi,AVSEEK_FLAG_BACKWARD:gi,AVSEEK_FLAG_BYTE:yi,AVSEEK_FLAG_ANY:Ei,AVSEEK_FLAG_FRAME:wi,AVDISCARD_NONE:bi,AVDISCARD_DEFAULT:vi,AVDISCARD_NONREF:Ti,AVDISCARD_BIDIR:Si,AVDISCARD_NONINTRA:Vi,AVDISCARD_NONKEY:Di,AVDISCARD_ALL:Pi,AV_LOG_QUIET:Ii,AV_LOG_PANIC:Ri,AV_LOG_FATAL:xi,AV_LOG_ERROR:Mi,AV_LOG_WARNING:Fi,AV_LOG_INFO:Oi,AV_LOG_VERBOSE:Ci,AV_LOG_DEBUG:ki,AV_LOG_TRACE:Ni,AV_PKT_FLAG_KEY:Li,AV_PKT_FLAG_CORRUPT:Ui,AV_PKT_FLAG_DISCARD:Xi,AV_PKT_FLAG_TRUSTED:Bi,AV_PKT_FLAG_DISPOSABLE:Gi,E2BIG:Yi,EPERM:$i,EADDRINUSE:zi,EADDRNOTAVAIL:Hi,EAFNOSUPPORT:Wi,EAGAIN:Ki,EALREADY:qi,EBADF:ji,EBADMSG:Ji,EBUSY:Qi,ECANCELED:Zi,ECHILD:en,ECONNABORTED:tn,ECONNREFUSED:rn,ECONNRESET:an,EDEADLOCK:nn,EDESTADDRREQ:on,EDOM:sn,EDQUOT:_n,EEXIST:ln,EFAULT:un,EFBIG:dn,EHOSTUNREACH:fn,EIDRM:cn,EILSEQ:mn,EINPROGRESS:pn,EINTR:An,EINVAL:hn,EIO:gn,EISCONN:yn,EISDIR:En,ELOOP:wn,EMFILE:bn,EMLINK:vn,EMSGSIZE:Tn,EMULTIHOP:Sn,ENAMETOOLONG:Vn,ENETDOWN:Dn,ENETRESET:Pn,ENETUNREACH:In,ENFILE:Rn,ENOBUFS:xn,ENODEV:Mn,ENOENT:Fn,AVERROR_EOF:On,LibAV:nt}=D,_e=D;function F(e){throw e}function ot(e){if(e instanceof Object){let t=e.toString();if("errno"in e){t=`(de)muxer error. ${e.errno}`;for(let[r,a]of Object.entries(nt))typeof a=="number"&&r.startsWith("E")&&a==e.errno&&(t=`(de)muxer error. ${r}`)}return t}return e.toString()}async function pe(e,t){if(t<0){let r=await e.strerror(t);F(r)}}async function Ae(e,t){if(t!=0){let r=await e.strerror(t);F(r)}}function J(e){var t=String(e);if(t==="[object Object]")try{t=JSON.stringify(e)}catch{}return t}var tr=(function(){function e(){}return e.prototype.isSome=function(){return!1},e.prototype.isNone=function(){return!0},e.prototype[Symbol.iterator]=function(){return{next:function(){return{done:!0,value:void 0}}}},e.prototype.unwrapOr=function(t){return t},e.prototype.expect=function(t){throw new Error("".concat(t))},e.prototype.unwrap=function(){throw new Error("Tried to unwrap None")},e.prototype.map=function(t){return this},e.prototype.mapOr=function(t,r){return t},e.prototype.mapOrElse=function(t,r){return t()},e.prototype.or=function(t){return t},e.prototype.orElse=function(t){return t()},e.prototype.andThen=function(t){return this},e.prototype.toResult=function(t){return v(t)},e.prototype.toString=function(){return"None"},e.prototype.toAsyncOption=function(){return new he(O)},e})(),O=new tr;Object.freeze(O);var rr=(function(){function e(t){if(!(this instanceof e))return new e(t);this.value=t}return e.prototype.isSome=function(){return!0},e.prototype.isNone=function(){return!1},e.prototype[Symbol.iterator]=function(){var t=Object(this.value);return Symbol.iterator in t?t[Symbol.iterator]():{next:function(){return{done:!0,value:void 0}}}},e.prototype.unwrapOr=function(t){return this.value},e.prototype.expect=function(t){return this.value},e.prototype.unwrap=function(){return this.value},e.prototype.map=function(t){return k(t(this.value))},e.prototype.mapOr=function(t,r){return r(this.value)},e.prototype.mapOrElse=function(t,r){return r(this.value)},e.prototype.or=function(t){return this},e.prototype.orElse=function(t){return this},e.prototype.andThen=function(t){return t(this.value)},e.prototype.toResult=function(t){return S(this.value)},e.prototype.toAsyncOption=function(){return new he(this)},e.prototype.safeUnwrap=function(){return this.value},e.prototype.toString=function(){return"Some(".concat(J(this.value),")")},e.EMPTY=new e(void 0),e})(),k=rr,Ce;(function(e){function t(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];for(var o=[],s=0,u=i;s<u.length;s++){var l=u[s];if(l.isSome())o.push(l.value);else return l}return k(o)}e.all=t;function r(){for(var i=[],n=0;n<arguments.length;n++)i[n]=arguments[n];for(var o=0,s=i;o<s.length;o++){var u=s[o];if(u.isSome())return u}return O}e.any=r;function a(i){return i instanceof k||i===O}e.isOption=a})(Ce||(Ce={}));var le=function(e,t,r){if(r||arguments.length===2)for(var a=0,i=t.length,n;a<i;a++)(n||!(a in t))&&(n||(n=Array.prototype.slice.call(t,0,a)),n[a]=t[a]);return e.concat(n||Array.prototype.slice.call(t))},ar=(function(){function e(t){if(!(this instanceof e))return new e(t);this.error=t;var r=new Error().stack.split(`
`).slice(2);r&&r.length>0&&r[0].includes("ErrImpl")&&r.shift(),this._stack=r.join(`
`)}return e.prototype.isOk=function(){return!1},e.prototype.isErr=function(){return!0},e.prototype[Symbol.iterator]=function(){return{next:function(){return{done:!0,value:void 0}}}},e.prototype.else=function(t){return t},e.prototype.unwrapOr=function(t){return t},e.prototype.expect=function(t){throw new Error("".concat(t," - Error: ").concat(J(this.error),`
`).concat(this._stack),{cause:this.error})},e.prototype.expectErr=function(t){return this.error},e.prototype.unwrap=function(){throw new Error("Tried to unwrap Error: ".concat(J(this.error),`
`).concat(this._stack),{cause:this.error})},e.prototype.unwrapErr=function(){return this.error},e.prototype.map=function(t){return this},e.prototype.andThen=function(t){return this},e.prototype.mapErr=function(t){return new v(t(this.error))},e.prototype.mapOr=function(t,r){return t},e.prototype.mapOrElse=function(t,r){return t(this.error)},e.prototype.or=function(t){return t},e.prototype.orElse=function(t){return t(this.error)},e.prototype.toOption=function(){return O},e.prototype.toString=function(){return"Err(".concat(J(this.error),")")},Object.defineProperty(e.prototype,"stack",{get:function(){return"".concat(this,`
`).concat(this._stack)},enumerable:!1,configurable:!0}),e.prototype.toAsyncResult=function(){return new ge(this)},e.EMPTY=new e(void 0),e})();var v=ar,ir=(function(){function e(t){if(!(this instanceof e))return new e(t);this.value=t}return e.prototype.isOk=function(){return!0},e.prototype.isErr=function(){return!1},e.prototype[Symbol.iterator]=function(){var t=Object(this.value);return Symbol.iterator in t?t[Symbol.iterator]():{next:function(){return{done:!0,value:void 0}}}},e.prototype.else=function(t){return this.value},e.prototype.unwrapOr=function(t){return this.value},e.prototype.expect=function(t){return this.value},e.prototype.expectErr=function(t){throw new Error(t)},e.prototype.unwrap=function(){return this.value},e.prototype.unwrapErr=function(){throw new Error("Tried to unwrap Ok: ".concat(J(this.value)),{cause:this.value})},e.prototype.map=function(t){return new S(t(this.value))},e.prototype.andThen=function(t){return t(this.value)},e.prototype.mapErr=function(t){return this},e.prototype.mapOr=function(t,r){return r(this.value)},e.prototype.mapOrElse=function(t,r){return r(this.value)},e.prototype.or=function(t){return this},e.prototype.orElse=function(t){return this},e.prototype.toOption=function(){return k(this.value)},e.prototype.safeUnwrap=function(){return this.value},e.prototype.toString=function(){return"Ok(".concat(J(this.value),")")},e.prototype.toAsyncResult=function(){return new ge(this)},e.EMPTY=new e(void 0),e})();var S=ir,ke;(function(e){function t(s){for(var u=[],l=1;l<arguments.length;l++)u[l-1]=arguments[l];for(var d=s===void 0?[]:Array.isArray(s)?s:le([s],u,!0),p=[],f=0,y=d;f<y.length;f++){var A=y[f];if(A.isOk())p.push(A.value);else return A}return new S(p)}e.all=t;function r(s){for(var u=[],l=1;l<arguments.length;l++)u[l-1]=arguments[l];for(var d=s===void 0?[]:Array.isArray(s)?s:le([s],u,!0),p=[],f=0,y=d;f<y.length;f++){var A=y[f];if(A.isOk())return A;p.push(A.error)}return new v(p)}e.any=r;function a(s){try{return new S(s())}catch(u){return new v(u)}}e.wrap=a;function i(s){try{return s().then(function(u){return new S(u)}).catch(function(u){return new v(u)})}catch(u){return Promise.resolve(new v(u))}}e.wrapAsync=i;function n(s){return s.reduce(function(u,l){var d=u[0],p=u[1];return l.isOk()?[le(le([],d,!0),[l.value],!1),p]:[d,le(le([],p,!0),[l.error],!1)]},[[],[]])}e.partition=n;function o(s){return s instanceof v||s instanceof S}e.isResult=o})(ke||(ke={}));var be=function(e,t,r,a){function i(n){return n instanceof r?n:new r(function(o){o(n)})}return new(r||(r=Promise))(function(n,o){function s(d){try{l(a.next(d))}catch(p){o(p)}}function u(d){try{l(a.throw(d))}catch(p){o(p)}}function l(d){d.done?n(d.value):i(d.value).then(s,u)}l((a=a.apply(e,t||[])).next())})},ve=function(e,t){var r={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},a,i,n,o;return o={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function s(l){return function(d){return u([l,d])}}function u(l){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(r=0)),r;)try{if(a=1,i&&(n=l[0]&2?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[l[0]&2,n.value]),l[0]){case 0:case 1:n=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,i=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(n=r.trys,!(n=n.length>0&&n[n.length-1])&&(l[0]===6||l[0]===2)){r=0;continue}if(l[0]===3&&(!n||l[1]>n[0]&&l[1]<n[3])){r.label=l[1];break}if(l[0]===6&&r.label<n[1]){r.label=n[1],n=l;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(l);break}n[2]&&r.ops.pop(),r.trys.pop();continue}l=t.call(e,r)}catch(d){l=[6,d],i=0}finally{a=n=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},ge=(function(){function e(t){this.promise=Promise.resolve(t)}return e.prototype.andThen=function(t){var r=this;return this.thenInternal(function(a){return be(r,void 0,void 0,function(){var i;return ve(this,function(n){return a.isErr()?[2,a]:(i=t(a.value),[2,i instanceof e?i.promise:i])})})})},e.prototype.map=function(t){var r=this;return this.thenInternal(function(a){return be(r,void 0,void 0,function(){var i;return ve(this,function(n){switch(n.label){case 0:return a.isErr()?[2,a]:(i=S,[4,t(a.value)]);case 1:return[2,i.apply(void 0,[n.sent()])]}})})})},e.prototype.mapErr=function(t){var r=this;return this.thenInternal(function(a){return be(r,void 0,void 0,function(){var i;return ve(this,function(n){switch(n.label){case 0:return a.isOk()?[2,a]:(i=v,[4,t(a.error)]);case 1:return[2,i.apply(void 0,[n.sent()])]}})})})},e.prototype.or=function(t){return this.orElse(function(){return t})},e.prototype.orElse=function(t){var r=this;return this.thenInternal(function(a){return be(r,void 0,void 0,function(){var i;return ve(this,function(n){return a.isOk()?[2,a]:(i=t(a.error),[2,i instanceof e?i.promise:i])})})})},e.prototype.toOption=function(){return new he(this.promise.then(function(t){return t.toOption()}))},e.prototype.thenInternal=function(t){return new e(this.promise.then(t))},e})();var Ne=function(e,t,r,a){function i(n){return n instanceof r?n:new r(function(o){o(n)})}return new(r||(r=Promise))(function(n,o){function s(d){try{l(a.next(d))}catch(p){o(p)}}function u(d){try{l(a.throw(d))}catch(p){o(p)}}function l(d){d.done?n(d.value):i(d.value).then(s,u)}l((a=a.apply(e,t||[])).next())})},Le=function(e,t){var r={label:0,sent:function(){if(n[0]&1)throw n[1];return n[1]},trys:[],ops:[]},a,i,n,o;return o={next:s(0),throw:s(1),return:s(2)},typeof Symbol=="function"&&(o[Symbol.iterator]=function(){return this}),o;function s(l){return function(d){return u([l,d])}}function u(l){if(a)throw new TypeError("Generator is already executing.");for(;o&&(o=0,l[0]&&(r=0)),r;)try{if(a=1,i&&(n=l[0]&2?i.return:l[0]?i.throw||((n=i.return)&&n.call(i),0):i.next)&&!(n=n.call(i,l[1])).done)return n;switch(i=0,n&&(l=[l[0]&2,n.value]),l[0]){case 0:case 1:n=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,i=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(n=r.trys,!(n=n.length>0&&n[n.length-1])&&(l[0]===6||l[0]===2)){r=0;continue}if(l[0]===3&&(!n||l[1]>n[0]&&l[1]<n[3])){r.label=l[1];break}if(l[0]===6&&r.label<n[1]){r.label=n[1],n=l;break}if(n&&r.label<n[2]){r.label=n[2],r.ops.push(l);break}n[2]&&r.ops.pop(),r.trys.pop();continue}l=t.call(e,r)}catch(d){l=[6,d],i=0}finally{a=n=0}if(l[0]&5)throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}},he=(function(){function e(t){this.promise=Promise.resolve(t)}return e.prototype.andThen=function(t){var r=this;return this.thenInternal(function(a){return Ne(r,void 0,void 0,function(){var i;return Le(this,function(n){return a.isNone()?[2,a]:(i=t(a.value),[2,i instanceof e?i.promise:i])})})})},e.prototype.map=function(t){var r=this;return this.thenInternal(function(a){return Ne(r,void 0,void 0,function(){var i;return Le(this,function(n){switch(n.label){case 0:return a.isNone()?[2,a]:(i=k,[4,t(a.value)]);case 1:return[2,i.apply(void 0,[n.sent()])]}})})})},e.prototype.or=function(t){return this.orElse(function(){return t})},e.prototype.orElse=function(t){var r=this;return this.thenInternal(function(a){return Ne(r,void 0,void 0,function(){var i;return Le(this,function(n){return a.isSome()?[2,a]:(i=t(),[2,i instanceof e?i.promise:i])})})})},e.prototype.toResult=function(t){return new ge(this.promise.then(function(r){return r.toResult(t)}))},e.prototype.thenInternal=function(t){return new e(this.promise.then(t))},e})();function z(e){if(e.__serde_tag=="primitive")return e.__serde_val;if(e.__serde_tag=="object"){let t={};for(let[r,a]of Object.entries(e.__serde_val)){let i=a;t[r]=z(i)}return t}else{if(e.__serde_tag=="map")return new Map(e.__serde_val.map(([t,r])=>[z(t),z(r)]));if(e.__serde_tag=="set")return new Set(e.__serde_val.map(z));if(e.__serde_tag=="url")return new URL(e.__serde_val);if(e.__serde_tag=="array")return e.__serde_val.map(z);if(e.__serde_tag=="headers")return new Headers(e.__serde_val);if(e.__serde_tag=="regex")return new RegExp(e.__serde_val[0],e.__serde_val[1]);if(e.__serde_tag=="some")return k(z(e.__serde_val));if(e.__serde_tag=="none")return O;if(e.__serde_tag=="ok")return S(z(e.__serde_val));if(e.__serde_tag=="err")return v(z(e.__serde_val));throw new Error("Unreachable")}}var Ue={FromInjectedToService:0,FromContentToService:1,FromServiceToWorker:2,FromWorkerToService:3,FromUntrustedInjectedToTrusted:4,FromTrustedInjectedToUntrusted:5,FromServiceToContent:6,FromServiceToInjected:7,FromServiceToService:8};var Xe=new BroadcastChannel("worker_service");function K(e){let t=Ue.FromWorkerToService;Xe.postMessage({msg:e,channel:t})}function st(e){let t=r=>{let a=r.data.msg;r.data.channel==Ue.FromServiceToWorker&&e(a)};return Xe.addEventListener("message",t),()=>{Xe.removeEventListener("message",t)}}var Y=class{constructor(t){this.download_id=t,this.progress={status:"queuing"},this.postNow()}schedulePost(){this.timeout||(this.timeout=setTimeout(()=>this.postNow(),500))}postNow(){this.timeout&&(clearTimeout(this.timeout),delete this.timeout),K({name:"download_progress",data:{download_id:this.download_id,progress:this.progress}})}set_progress(t){this.progress=t,this.schedulePost()}set_duration_in_s(t){this.progress.status=="downloading"&&(this.progress.output_duration_s=t)}add_bytes(t){this.progress.status=="downloading"?this.progress.fetched_bytes_count+=t:this.progress.status=="queuing"&&(this.progress={status:"downloading",percent:{is_known:!0,value:0},fetched_bytes_count:t,output_duration_s:0}),this.schedulePost()}dont_trust_percent(){this.progress.status=="downloading"&&(this.progress.percent.is_known=!1,this.schedulePost())}set_percent(t){this.progress.status=="downloading"&&this.progress.percent.is_known?this.progress.percent.value=t:this.progress.status=="queuing"&&(this.progress={status:"downloading",percent:{is_known:!0,value:t},fetched_bytes_count:0,output_duration_s:0}),this.schedulePost()}},Te=class extends Y{constructor(t){super(t)}nextStream(){this.second_stream=!0,this.progress={status:"queuing"},this.postNow()}postNow(){if(this.timeout&&(clearTimeout(this.timeout),delete this.timeout),!(!this.second_stream&&this.progress.status=="finalizing")){if(!(this.second_stream&&this.progress.status=="queuing")){let t=structuredClone(this.progress);t.status=="downloading"&&t.percent.is_known&&(this.second_stream?(t.percent.value*=.5,t.percent.value+=50):t.percent.value*=.5),K({name:"download_progress",data:{download_id:this.download_id,progress:t}})}}}};var H=class{constructor(){this.filename_writable_map=new Map}async open(t){let a=await(await navigator.storage.getDirectory()).getFileHandle(t,{create:!0}),i=await a.createSyncAccessHandle();this.filename_writable_map.set(t,{writable:i,handle:a,size:0})}async onwrite(t,r,a){let i=this.filename_writable_map.get(t);i&&(await i.writable.write(a,{at:r}),i.size+=a.length)}async close(t){let r=this.filename_writable_map.get(t);if(!r)return 0;await r.writable.close();let a=this.filename_writable_map.get(t)?.size;return this.filename_writable_map.delete(t),a||0}async remove(t){await(await navigator.storage.getDirectory()).removeEntry(t)}};async function N(e,t){let i=await(await(await navigator.storage.getDirectory()).getFileHandle(t)).getFile();switch(e.extension){case"mkv":return URL.createObjectURL(new File([i],t,{type:"video/x-matroska"}));case"flv":return URL.createObjectURL(new File([i],t,{type:"video/x-flv"}));default:return URL.createObjectURL(i)}}function ae(){return{user_abort:!0,e4XX_5XX_failure:!1,other_failure:!1,percentage_incomplete:!1}}function Be(){return{user_abort:!1,e4XX_5XX_failure:!1,other_failure:!1,percentage_incomplete:!0}}function P(e){return{user_abort:!1,e4XX_5XX_failure:!1,percentage_incomplete:!1,other_failure:!0,message:e}}function Se(e){return{user_abort:!1,e4XX_5XX_failure:!0,percentage_incomplete:!1,other_failure:!1,status:e}}function _t(e){return e==255||e==-1415072069}function Ge(e){return e<1e3?Se(e):e==1001?P("Network error"):P("Read() error")}function Ye(e){return e?e>0&&e<1e3||e==1001||e==1002:!1}async function X(e,t,r,a){let i=await _e.LibAV({noworker:!0}),n=new H;i.onwrite=n.onwrite.bind(n);let o=!1;t.addEventListener("abort",async E=>{p&&(await i.ffmpeg_interrupt(),p=!1,o=!0)});let s=new Y(e.download_id),u=0,l=()=>{setTimeout(async()=>{let E=await i.ffmpeg_get_total_size_bytes(),m=E-u;u=E,s.add_bytes(m);let c=await i.ffmpeg_get_out_time_ms();if(s.set_duration_in_s(c/1e3),e.strategy=="http_strip_audio_jsfetch")s.dont_trust_percent();else if("duration"in e&&typeof e.duration=="number"){let h=e.duration*1e3,x=100*(c/h);s.set_percent(x)}else if("size"in e&&e.size.isSome()){let h=e.size.value,x=100*(E/h);s.set_percent(x)}else s.dont_trust_percent();p&&l()},500)},d,p=!1,f=0,y;await n.open(r);try{await i.mkwriterdev(r),p=!0,l(),d=await i.ffmpeg(a)}catch(E){y=`${E}`}finally{f=await n.close(r),p=!1}let A=f<1e3,_=!1,w=0;if("duration"in e&&typeof e.duration=="number"){let E=e.duration*1e3;w=100*(await i.ffmpeg_get_out_time_ms()/E),_=w<95}else if("size"in e&&e.size.isSome()){let E=await i.ffmpeg_get_total_size_bytes(),m=e.size.value;w=100*(E/m),_=w<90}if(y)return w<=5?(await n.remove(r),{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P(`Unknown libav error: ${y}`)}):{internal_filename:r,aborted_no_partial:!1,internal_bloburl:await N(e,r),download_id:e.download_id,ending_reason:Be()};if(A){if(await n.remove(r),_t(d)||o)return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:ae()};if(d!=0&&d!=null){if(Ye(d))return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:Ge(d)};let E=await i.strerror(d);return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P(E)}}else return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P(`Expected larger size, but only got ${f} bytes`)}}if(_t(d)||o)return{internal_filename:r,aborted_no_partial:!1,internal_bloburl:await N(e,r),download_id:e.download_id,ending_reason:ae()};if(_&&w>=5){let E=Ye(d)?Ge(d):Be();return{internal_filename:r,aborted_no_partial:!1,internal_bloburl:await N(e,r),download_id:e.download_id,ending_reason:E}}if(d==0)return{internal_filename:r,aborted_no_partial:!1,internal_bloburl:await N(e,r),download_id:e.download_id,ending_reason:"end_of_file"};if(d&&Ye(d))return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:Ge(d)};if(d){await n.remove(r);let E=await i.strerror(d);return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P(E)}}return await n.remove(r),{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("Unreachable")}}async function lt(e,t){let r=`${e.download_id}.${e.extension}`;return await X(e,t,r,["-analyzeduration","10M","-f","dash","-i",`jsfetch:${e.url}`,"-map",`0:${e.entry}`,"-map","0:a:0?","-c","copy","-avoid_negative_ts","make_zero","-y",r])}async function ut(e,t){let r=`${e.download_id}.${e.extension}`;return await X(e,t,r,["-analyzeduration","10M","-f","dash","-i",`jsfetch:${e.url}`,"-map","0:a:0","-c:a","libmp3lame","-avoid_negative_ts","make_zero","-y",r])}async function dt(e,t){let r=`${e.download_id}.${e.extension}`;return await X(e,t,r,["-analyzeduration","1M","-f","dash","-i",`jsfetch:${e.url}`,"-map",`0:${e.entry}`,"-t","3","-c","copy","-avoid_negative_ts","make_zero","-y",r])}var Ve=(function(){function e(){this.listeners={}}var t=e.prototype;return t.on=function(a,i){this.listeners[a]||(this.listeners[a]=[]),this.listeners[a].push(i)},t.off=function(a,i){if(!this.listeners[a])return!1;var n=this.listeners[a].indexOf(i);return this.listeners[a]=this.listeners[a].slice(0),this.listeners[a].splice(n,1),n>-1},t.trigger=function(a){var i=this.listeners[a];if(i)if(arguments.length===2)for(var n=i.length,o=0;o<n;++o)i[o].call(this,arguments[1]);else for(var s=Array.prototype.slice.call(arguments,1),u=i.length,l=0;l<u;++l)i[l].apply(this,s)},t.dispose=function(){this.listeners={}},t.pipe=function(a){this.on("data",function(i){a.push(i)})},e})();function ie(){return ie=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var a in r)({}).hasOwnProperty.call(r,a)&&(e[a]=r[a])}return e},ie.apply(null,arguments)}var $e=er(ct()),_r=function(t){return $e.default.atob?$e.default.atob(t):Buffer.from(t,"base64").toString("binary")};function ze(e){for(var t=_r(e),r=new Uint8Array(t.length),a=0;a<t.length;a++)r[a]=t.charCodeAt(a);return r}var Ke=class extends Ve{constructor(){super(),this.buffer=""}push(t){let r;for(this.buffer+=t,r=this.buffer.indexOf(`
`);r>-1;r=this.buffer.indexOf(`
`))this.trigger("data",this.buffer.substring(0,r)),this.buffer=this.buffer.substring(r+1)}},lr="	",He=function(e){let t=/([0-9.]*)?@?([0-9.]*)?/.exec(e||""),r={};return t[1]&&(r.length=parseInt(t[1],10)),t[2]&&(r.offset=parseInt(t[2],10)),r},ur=function(){let r="(?:"+"[^=]*"+")=(?:"+'"[^"]*"|[^,]*'+")";return new RegExp("(?:^|,)("+r+")")},C=function(e){let t={};if(!e)return t;let r=e.split(ur()),a=r.length,i;for(;a--;)r[a]!==""&&(i=/([^=]*)=(.*)/.exec(r[a]).slice(1),i[0]=i[0].replace(/^\s+|\s+$/g,""),i[1]=i[1].replace(/^\s+|\s+$/g,""),i[1]=i[1].replace(/^['"](.*)['"]$/g,"$1"),t[i[0]]=i[1]);return t},mt=e=>{let t=e.split("x"),r={};return t[0]&&(r.width=parseInt(t[0],10)),t[1]&&(r.height=parseInt(t[1],10)),r},qe=class extends Ve{constructor(){super(),this.customParsers=[],this.tagMappers=[]}push(t){let r,a;if(t=t.trim(),t.length===0)return;if(t[0]!=="#"){this.trigger("data",{type:"uri",uri:t});return}this.tagMappers.reduce((n,o)=>{let s=o(t);return s===t?n:n.concat([s])},[t]).forEach(n=>{for(let o=0;o<this.customParsers.length;o++)if(this.customParsers[o].call(this,n))return;if(n.indexOf("#EXT")!==0){this.trigger("data",{type:"comment",text:n.slice(1)});return}if(n=n.replace("\r",""),r=/^#EXTM3U/.exec(n),r){this.trigger("data",{type:"tag",tagType:"m3u"});return}if(r=/^#EXTINF:([0-9\.]*)?,?(.*)?$/.exec(n),r){a={type:"tag",tagType:"inf"},r[1]&&(a.duration=parseFloat(r[1])),r[2]&&(a.title=r[2]),this.trigger("data",a);return}if(r=/^#EXT-X-TARGETDURATION:([0-9.]*)?/.exec(n),r){a={type:"tag",tagType:"targetduration"},r[1]&&(a.duration=parseInt(r[1],10)),this.trigger("data",a);return}if(r=/^#EXT-X-VERSION:([0-9.]*)?/.exec(n),r){a={type:"tag",tagType:"version"},r[1]&&(a.version=parseInt(r[1],10)),this.trigger("data",a);return}if(r=/^#EXT-X-MEDIA-SEQUENCE:(\-?[0-9.]*)?/.exec(n),r){a={type:"tag",tagType:"media-sequence"},r[1]&&(a.number=parseInt(r[1],10)),this.trigger("data",a);return}if(r=/^#EXT-X-DISCONTINUITY-SEQUENCE:(\-?[0-9.]*)?/.exec(n),r){a={type:"tag",tagType:"discontinuity-sequence"},r[1]&&(a.number=parseInt(r[1],10)),this.trigger("data",a);return}if(r=/^#EXT-X-PLAYLIST-TYPE:(.*)?$/.exec(n),r){a={type:"tag",tagType:"playlist-type"},r[1]&&(a.playlistType=r[1]),this.trigger("data",a);return}if(r=/^#EXT-X-BYTERANGE:(.*)?$/.exec(n),r){a=ie(He(r[1]),{type:"tag",tagType:"byterange"}),this.trigger("data",a);return}if(r=/^#EXT-X-ALLOW-CACHE:(YES|NO)?/.exec(n),r){a={type:"tag",tagType:"allow-cache"},r[1]&&(a.allowed=!/NO/.test(r[1])),this.trigger("data",a);return}if(r=/^#EXT-X-MAP:(.*)$/.exec(n),r){if(a={type:"tag",tagType:"map"},r[1]){let o=C(r[1]);o.URI&&(a.uri=o.URI),o.BYTERANGE&&(a.byterange=He(o.BYTERANGE))}this.trigger("data",a);return}if(r=/^#EXT-X-STREAM-INF:(.*)$/.exec(n),r){a={type:"tag",tagType:"stream-inf"},r[1]&&(a.attributes=C(r[1]),a.attributes.RESOLUTION&&(a.attributes.RESOLUTION=mt(a.attributes.RESOLUTION)),a.attributes.BANDWIDTH&&(a.attributes.BANDWIDTH=parseInt(a.attributes.BANDWIDTH,10)),a.attributes["FRAME-RATE"]&&(a.attributes["FRAME-RATE"]=parseFloat(a.attributes["FRAME-RATE"])),a.attributes["PROGRAM-ID"]&&(a.attributes["PROGRAM-ID"]=parseInt(a.attributes["PROGRAM-ID"],10))),this.trigger("data",a);return}if(r=/^#EXT-X-MEDIA:(.*)$/.exec(n),r){a={type:"tag",tagType:"media"},r[1]&&(a.attributes=C(r[1])),this.trigger("data",a);return}if(r=/^#EXT-X-ENDLIST/.exec(n),r){this.trigger("data",{type:"tag",tagType:"endlist"});return}if(r=/^#EXT-X-DISCONTINUITY/.exec(n),r){this.trigger("data",{type:"tag",tagType:"discontinuity"});return}if(r=/^#EXT-X-PROGRAM-DATE-TIME:(.*)$/.exec(n),r){a={type:"tag",tagType:"program-date-time"},r[1]&&(a.dateTimeString=r[1],a.dateTimeObject=new Date(r[1])),this.trigger("data",a);return}if(r=/^#EXT-X-KEY:(.*)$/.exec(n),r){a={type:"tag",tagType:"key"},r[1]&&(a.attributes=C(r[1]),a.attributes.IV&&(a.attributes.IV.substring(0,2).toLowerCase()==="0x"&&(a.attributes.IV=a.attributes.IV.substring(2)),a.attributes.IV=a.attributes.IV.match(/.{8}/g),a.attributes.IV[0]=parseInt(a.attributes.IV[0],16),a.attributes.IV[1]=parseInt(a.attributes.IV[1],16),a.attributes.IV[2]=parseInt(a.attributes.IV[2],16),a.attributes.IV[3]=parseInt(a.attributes.IV[3],16),a.attributes.IV=new Uint32Array(a.attributes.IV))),this.trigger("data",a);return}if(r=/^#EXT-X-START:(.*)$/.exec(n),r){a={type:"tag",tagType:"start"},r[1]&&(a.attributes=C(r[1]),a.attributes["TIME-OFFSET"]=parseFloat(a.attributes["TIME-OFFSET"]),a.attributes.PRECISE=/YES/.test(a.attributes.PRECISE)),this.trigger("data",a);return}if(r=/^#EXT-X-CUE-OUT-CONT:(.*)?$/.exec(n),r){a={type:"tag",tagType:"cue-out-cont"},r[1]?a.data=r[1]:a.data="",this.trigger("data",a);return}if(r=/^#EXT-X-CUE-OUT:(.*)?$/.exec(n),r){a={type:"tag",tagType:"cue-out"},r[1]?a.data=r[1]:a.data="",this.trigger("data",a);return}if(r=/^#EXT-X-CUE-IN:?(.*)?$/.exec(n),r){a={type:"tag",tagType:"cue-in"},r[1]?a.data=r[1]:a.data="",this.trigger("data",a);return}if(r=/^#EXT-X-SKIP:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"skip"},a.attributes=C(r[1]),a.attributes.hasOwnProperty("SKIPPED-SEGMENTS")&&(a.attributes["SKIPPED-SEGMENTS"]=parseInt(a.attributes["SKIPPED-SEGMENTS"],10)),a.attributes.hasOwnProperty("RECENTLY-REMOVED-DATERANGES")&&(a.attributes["RECENTLY-REMOVED-DATERANGES"]=a.attributes["RECENTLY-REMOVED-DATERANGES"].split(lr)),this.trigger("data",a);return}if(r=/^#EXT-X-PART:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"part"},a.attributes=C(r[1]),["DURATION"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=parseFloat(a.attributes[o]))}),["INDEPENDENT","GAP"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=/YES/.test(a.attributes[o]))}),a.attributes.hasOwnProperty("BYTERANGE")&&(a.attributes.byterange=He(a.attributes.BYTERANGE)),this.trigger("data",a);return}if(r=/^#EXT-X-SERVER-CONTROL:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"server-control"},a.attributes=C(r[1]),["CAN-SKIP-UNTIL","PART-HOLD-BACK","HOLD-BACK"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=parseFloat(a.attributes[o]))}),["CAN-SKIP-DATERANGES","CAN-BLOCK-RELOAD"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=/YES/.test(a.attributes[o]))}),this.trigger("data",a);return}if(r=/^#EXT-X-PART-INF:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"part-inf"},a.attributes=C(r[1]),["PART-TARGET"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=parseFloat(a.attributes[o]))}),this.trigger("data",a);return}if(r=/^#EXT-X-PRELOAD-HINT:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"preload-hint"},a.attributes=C(r[1]),["BYTERANGE-START","BYTERANGE-LENGTH"].forEach(function(o){if(a.attributes.hasOwnProperty(o)){a.attributes[o]=parseInt(a.attributes[o],10);let s=o==="BYTERANGE-LENGTH"?"length":"offset";a.attributes.byterange=a.attributes.byterange||{},a.attributes.byterange[s]=a.attributes[o],delete a.attributes[o]}}),this.trigger("data",a);return}if(r=/^#EXT-X-RENDITION-REPORT:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"rendition-report"},a.attributes=C(r[1]),["LAST-MSN","LAST-PART"].forEach(function(o){a.attributes.hasOwnProperty(o)&&(a.attributes[o]=parseInt(a.attributes[o],10))}),this.trigger("data",a);return}if(r=/^#EXT-X-DATERANGE:(.*)$/.exec(n),r&&r[1]){a={type:"tag",tagType:"daterange"},a.attributes=C(r[1]),["ID","CLASS"].forEach(function(s){a.attributes.hasOwnProperty(s)&&(a.attributes[s]=String(a.attributes[s]))}),["START-DATE","END-DATE"].forEach(function(s){a.attributes.hasOwnProperty(s)&&(a.attributes[s]=new Date(a.attributes[s]))}),["DURATION","PLANNED-DURATION"].forEach(function(s){a.attributes.hasOwnProperty(s)&&(a.attributes[s]=parseFloat(a.attributes[s]))}),["END-ON-NEXT"].forEach(function(s){a.attributes.hasOwnProperty(s)&&(a.attributes[s]=/YES/i.test(a.attributes[s]))}),["SCTE35-CMD"," SCTE35-OUT","SCTE35-IN"].forEach(function(s){a.attributes.hasOwnProperty(s)&&(a.attributes[s]=a.attributes[s].toString(16))});let o=/^X-([A-Z]+-)+[A-Z]+$/;for(let s in a.attributes){if(!o.test(s))continue;let u=/[0-9A-Fa-f]{6}/g.test(a.attributes[s]),l=/^\d+(\.\d+)?$/.test(a.attributes[s]);a.attributes[s]=u?a.attributes[s].toString(16):l?parseFloat(a.attributes[s]):String(a.attributes[s])}this.trigger("data",a);return}if(r=/^#EXT-X-INDEPENDENT-SEGMENTS/.exec(n),r){this.trigger("data",{type:"tag",tagType:"independent-segments"});return}if(r=/^#EXT-X-I-FRAMES-ONLY/.exec(n),r){this.trigger("data",{type:"tag",tagType:"i-frames-only"});return}if(r=/^#EXT-X-CONTENT-STEERING:(.*)$/.exec(n),r){a={type:"tag",tagType:"content-steering"},a.attributes=C(r[1]),this.trigger("data",a);return}if(r=/^#EXT-X-I-FRAME-STREAM-INF:(.*)$/.exec(n),r){a={type:"tag",tagType:"i-frame-playlist"},a.attributes=C(r[1]),a.attributes.URI&&(a.uri=a.attributes.URI),a.attributes.BANDWIDTH&&(a.attributes.BANDWIDTH=parseInt(a.attributes.BANDWIDTH,10)),a.attributes.RESOLUTION&&(a.attributes.RESOLUTION=mt(a.attributes.RESOLUTION)),a.attributes["AVERAGE-BANDWIDTH"]&&(a.attributes["AVERAGE-BANDWIDTH"]=parseInt(a.attributes["AVERAGE-BANDWIDTH"],10)),a.attributes["FRAME-RATE"]&&(a.attributes["FRAME-RATE"]=parseFloat(a.attributes["FRAME-RATE"])),this.trigger("data",a);return}if(r=/^#EXT-X-DEFINE:(.*)$/.exec(n),r){a={type:"tag",tagType:"define"},a.attributes=C(r[1]),this.trigger("data",a);return}this.trigger("data",{type:"tag",data:n.slice(4)})})}addParser({expression:t,customType:r,dataParser:a,segment:i}){typeof a!="function"&&(a=n=>n),this.customParsers.push(n=>{if(t.exec(n))return this.trigger("data",{type:"custom",data:a(n),customType:r,segment:i}),!0})}addTagMapper({expression:t,map:r}){let a=i=>t.test(i)?r(i):i;this.tagMappers.push(a)}},dr=e=>e.toLowerCase().replace(/-(\w)/g,t=>t[1].toUpperCase()),Q=function(e){let t={};return Object.keys(e).forEach(function(r){t[dr(r)]=e[r]}),t},We=function(e){let{serverControl:t,targetDuration:r,partTargetDuration:a}=e;if(!t)return;let i="#EXT-X-SERVER-CONTROL",n="holdBack",o="partHoldBack",s=r&&r*3,u=a&&a*2;r&&!t.hasOwnProperty(n)&&(t[n]=s,this.trigger("info",{message:`${i} defaulting HOLD-BACK to targetDuration * 3 (${s}).`})),s&&t[n]<s&&(this.trigger("warn",{message:`${i} clamping HOLD-BACK (${t[n]}) to targetDuration * 3 (${s})`}),t[n]=s),a&&!t.hasOwnProperty(o)&&(t[o]=a*3,this.trigger("info",{message:`${i} defaulting PART-HOLD-BACK to partTargetDuration * 3 (${t[o]}).`})),a&&t[o]<u&&(this.trigger("warn",{message:`${i} clamping PART-HOLD-BACK (${t[o]}) to partTargetDuration * 2 (${u}).`}),t[o]=u)},Ee=class extends Ve{constructor(t={}){super(),this.lineStream=new Ke,this.parseStream=new qe,this.lineStream.pipe(this.parseStream),this.mainDefinitions=t.mainDefinitions||{},this.params=new URL(t.uri,"https://a.com").searchParams,this.lastProgramDateTime=null;let r=this,a=[],i={},n,o,s=!1,u=function(){},l={AUDIO:{},VIDEO:{},"CLOSED-CAPTIONS":{},SUBTITLES:{}},d="urn:uuid:edef8ba9-79d6-4ace-a3c8-27dcd51d21ed",p=0;this.manifest={allowCache:!0,discontinuityStarts:[],dateRanges:[],iFramePlaylists:[],segments:[]};let f=0,y=0,A={};this.on("end",()=>{i.uri||!i.parts&&!i.preloadHints||(!i.map&&n&&(i.map=n),!i.key&&o&&(i.key=o),!i.timeline&&typeof p=="number"&&(i.timeline=p),this.manifest.preloadSegment=i)}),this.parseStream.on("data",function(_){let w,E;if(r.manifest.definitions){for(let m in r.manifest.definitions)if(_.uri&&(_.uri=_.uri.replace(`{$${m}}`,r.manifest.definitions[m])),_.attributes)for(let c in _.attributes)typeof _.attributes[c]=="string"&&(_.attributes[c]=_.attributes[c].replace(`{$${m}}`,r.manifest.definitions[m]))}({tag(){({version(){_.version&&(this.manifest.version=_.version)},"allow-cache"(){this.manifest.allowCache=_.allowed,"allowed"in _||(this.trigger("info",{message:"defaulting allowCache to YES"}),this.manifest.allowCache=!0)},byterange(){let m={};"length"in _&&(i.byterange=m,m.length=_.length,"offset"in _||(_.offset=f)),"offset"in _&&(i.byterange=m,m.offset=_.offset),f=m.offset+m.length},endlist(){this.manifest.endList=!0},inf(){"mediaSequence"in this.manifest||(this.manifest.mediaSequence=0,this.trigger("info",{message:"defaulting media sequence to zero"})),"discontinuitySequence"in this.manifest||(this.manifest.discontinuitySequence=0,this.trigger("info",{message:"defaulting discontinuity sequence to zero"})),_.title&&(i.title=_.title),_.duration>0&&(i.duration=_.duration),_.duration===0&&(i.duration=.01,this.trigger("info",{message:"updating zero segment duration to a small value"})),this.manifest.segments=a},key(){if(!_.attributes){this.trigger("warn",{message:"ignoring key declaration without attribute list"});return}if(_.attributes.METHOD==="NONE"){o=null;return}if(!_.attributes.URI){this.trigger("warn",{message:"ignoring key declaration without URI"});return}if(_.attributes.KEYFORMAT==="com.apple.streamingkeydelivery"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.apple.fps.1_0"]={attributes:_.attributes};return}if(_.attributes.KEYFORMAT==="com.microsoft.playready"){this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.microsoft.playready"]={uri:_.attributes.URI};return}if(_.attributes.KEYFORMAT===d){if(["SAMPLE-AES","SAMPLE-AES-CTR","SAMPLE-AES-CENC"].indexOf(_.attributes.METHOD)===-1){this.trigger("warn",{message:"invalid key method provided for Widevine"});return}if(_.attributes.METHOD==="SAMPLE-AES-CENC"&&this.trigger("warn",{message:"SAMPLE-AES-CENC is deprecated, please use SAMPLE-AES-CTR instead"}),_.attributes.URI.substring(0,23)!=="data:text/plain;base64,"){this.trigger("warn",{message:"invalid key URI provided for Widevine"});return}if(!(_.attributes.KEYID&&_.attributes.KEYID.substring(0,2)==="0x")){this.trigger("warn",{message:"invalid key ID provided for Widevine"});return}this.manifest.contentProtection=this.manifest.contentProtection||{},this.manifest.contentProtection["com.widevine.alpha"]={attributes:{schemeIdUri:_.attributes.KEYFORMAT,keyId:_.attributes.KEYID.substring(2)},pssh:ze(_.attributes.URI.split(",")[1])};return}_.attributes.METHOD||this.trigger("warn",{message:"defaulting key method to AES-128"}),o={method:_.attributes.METHOD||"AES-128",uri:_.attributes.URI},typeof _.attributes.IV<"u"&&(o.iv=_.attributes.IV)},"media-sequence"(){if(!isFinite(_.number)){this.trigger("warn",{message:"ignoring invalid media sequence: "+_.number});return}this.manifest.mediaSequence=_.number},"discontinuity-sequence"(){if(!isFinite(_.number)){this.trigger("warn",{message:"ignoring invalid discontinuity sequence: "+_.number});return}this.manifest.discontinuitySequence=_.number,p=_.number},"playlist-type"(){if(!/VOD|EVENT/.test(_.playlistType)){this.trigger("warn",{message:"ignoring unknown playlist type: "+_.playlist});return}this.manifest.playlistType=_.playlistType},map(){n={},_.uri&&(n.uri=_.uri),_.byterange&&(n.byterange=_.byterange),o&&(n.key=o)},"stream-inf"(){if(this.manifest.playlists=a,this.manifest.mediaGroups=this.manifest.mediaGroups||l,!_.attributes){this.trigger("warn",{message:"ignoring empty stream-inf attributes"});return}i.attributes||(i.attributes={}),ie(i.attributes,_.attributes)},media(){if(this.manifest.mediaGroups=this.manifest.mediaGroups||l,!(_.attributes&&_.attributes.TYPE&&_.attributes["GROUP-ID"]&&_.attributes.NAME)){this.trigger("warn",{message:"ignoring incomplete or missing media group"});return}let m=this.manifest.mediaGroups[_.attributes.TYPE];m[_.attributes["GROUP-ID"]]=m[_.attributes["GROUP-ID"]]||{},w=m[_.attributes["GROUP-ID"]],E={default:/yes/i.test(_.attributes.DEFAULT)},E.default?E.autoselect=!0:E.autoselect=/yes/i.test(_.attributes.AUTOSELECT),_.attributes.LANGUAGE&&(E.language=_.attributes.LANGUAGE),_.attributes.URI&&(E.uri=_.attributes.URI),_.attributes["INSTREAM-ID"]&&(E.instreamId=_.attributes["INSTREAM-ID"]),_.attributes.CHARACTERISTICS&&(E.characteristics=_.attributes.CHARACTERISTICS),_.attributes.FORCED&&(E.forced=/yes/i.test(_.attributes.FORCED)),w[_.attributes.NAME]=E},discontinuity(){p+=1,i.discontinuity=!0,this.manifest.discontinuityStarts.push(a.length)},"program-date-time"(){typeof this.manifest.dateTimeString>"u"&&(this.manifest.dateTimeString=_.dateTimeString,this.manifest.dateTimeObject=_.dateTimeObject),i.dateTimeString=_.dateTimeString,i.dateTimeObject=_.dateTimeObject;let{lastProgramDateTime:m}=this;this.lastProgramDateTime=new Date(_.dateTimeString).getTime(),m===null&&this.manifest.segments.reduceRight((c,h)=>(h.programDateTime=c-h.duration*1e3,h.programDateTime),this.lastProgramDateTime)},targetduration(){if(!isFinite(_.duration)||_.duration<0){this.trigger("warn",{message:"ignoring invalid target duration: "+_.duration});return}this.manifest.targetDuration=_.duration,We.call(this,this.manifest)},start(){if(!_.attributes||isNaN(_.attributes["TIME-OFFSET"])){this.trigger("warn",{message:"ignoring start declaration without appropriate attribute list"});return}this.manifest.start={timeOffset:_.attributes["TIME-OFFSET"],precise:_.attributes.PRECISE}},"cue-out"(){i.cueOut=_.data},"cue-out-cont"(){i.cueOutCont=_.data},"cue-in"(){i.cueIn=_.data},skip(){this.manifest.skip=Q(_.attributes),this.warnOnMissingAttributes_("#EXT-X-SKIP",_.attributes,["SKIPPED-SEGMENTS"])},part(){s=!0;let m=this.manifest.segments.length,c=Q(_.attributes);i.parts=i.parts||[],i.parts.push(c),c.byterange&&(c.byterange.hasOwnProperty("offset")||(c.byterange.offset=y),y=c.byterange.offset+c.byterange.length);let h=i.parts.length-1;this.warnOnMissingAttributes_(`#EXT-X-PART #${h} for segment #${m}`,_.attributes,["URI","DURATION"]),this.manifest.renditionReports&&this.manifest.renditionReports.forEach((x,T)=>{x.hasOwnProperty("lastPart")||this.trigger("warn",{message:`#EXT-X-RENDITION-REPORT #${T} lacks required attribute(s): LAST-PART`})})},"server-control"(){let m=this.manifest.serverControl=Q(_.attributes);m.hasOwnProperty("canBlockReload")||(m.canBlockReload=!1,this.trigger("info",{message:"#EXT-X-SERVER-CONTROL defaulting CAN-BLOCK-RELOAD to false"})),We.call(this,this.manifest),m.canSkipDateranges&&!m.hasOwnProperty("canSkipUntil")&&this.trigger("warn",{message:"#EXT-X-SERVER-CONTROL lacks required attribute CAN-SKIP-UNTIL which is required when CAN-SKIP-DATERANGES is set"})},"preload-hint"(){let m=this.manifest.segments.length,c=Q(_.attributes),h=c.type&&c.type==="PART";i.preloadHints=i.preloadHints||[],i.preloadHints.push(c),c.byterange&&(c.byterange.hasOwnProperty("offset")||(c.byterange.offset=h?y:0,h&&(y=c.byterange.offset+c.byterange.length)));let x=i.preloadHints.length-1;if(this.warnOnMissingAttributes_(`#EXT-X-PRELOAD-HINT #${x} for segment #${m}`,_.attributes,["TYPE","URI"]),!!c.type)for(let T=0;T<i.preloadHints.length-1;T++){let V=i.preloadHints[T];V.type&&V.type===c.type&&this.trigger("warn",{message:`#EXT-X-PRELOAD-HINT #${x} for segment #${m} has the same TYPE ${c.type} as preload hint #${T}`})}},"rendition-report"(){let m=Q(_.attributes);this.manifest.renditionReports=this.manifest.renditionReports||[],this.manifest.renditionReports.push(m);let c=this.manifest.renditionReports.length-1,h=["LAST-MSN","URI"];s&&h.push("LAST-PART"),this.warnOnMissingAttributes_(`#EXT-X-RENDITION-REPORT #${c}`,_.attributes,h)},"part-inf"(){this.manifest.partInf=Q(_.attributes),this.warnOnMissingAttributes_("#EXT-X-PART-INF",_.attributes,["PART-TARGET"]),this.manifest.partInf.partTarget&&(this.manifest.partTargetDuration=this.manifest.partInf.partTarget),We.call(this,this.manifest)},daterange(){this.manifest.dateRanges.push(Q(_.attributes));let m=this.manifest.dateRanges.length-1;this.warnOnMissingAttributes_(`#EXT-X-DATERANGE #${m}`,_.attributes,["ID","START-DATE"]);let c=this.manifest.dateRanges[m];c.endDate&&c.startDate&&new Date(c.endDate)<new Date(c.startDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE END-DATE must be equal to or later than the value of the START-DATE"}),c.duration&&c.duration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE DURATION must not be negative"}),c.plannedDuration&&c.plannedDuration<0&&this.trigger("warn",{message:"EXT-X-DATERANGE PLANNED-DURATION must not be negative"});let h=!!c.endOnNext;if(h&&!c.class&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must have a CLASS attribute"}),h&&(c.duration||c.endDate)&&this.trigger("warn",{message:"EXT-X-DATERANGE with an END-ON-NEXT=YES attribute must not contain DURATION or END-DATE attributes"}),c.duration&&c.endDate){let T=c.startDate.getTime()+c.duration*1e3;this.manifest.dateRanges[m].endDate=new Date(T)}if(!A[c.id])A[c.id]=c;else{for(let T in A[c.id])if(c[T]&&JSON.stringify(A[c.id][T])!==JSON.stringify(c[T])){this.trigger("warn",{message:"EXT-X-DATERANGE tags with the same ID in a playlist must have the same attributes values"});break}let x=this.manifest.dateRanges.findIndex(T=>T.id===c.id);this.manifest.dateRanges[x]=ie(this.manifest.dateRanges[x],c),A[c.id]=ie(A[c.id],c),this.manifest.dateRanges.pop()}},"independent-segments"(){this.manifest.independentSegments=!0},"i-frames-only"(){this.manifest.iFramesOnly=!0,this.requiredCompatibilityversion(this.manifest.version,4)},"content-steering"(){this.manifest.contentSteering=Q(_.attributes),this.warnOnMissingAttributes_("#EXT-X-CONTENT-STEERING",_.attributes,["SERVER-URI"])},define(){this.manifest.definitions=this.manifest.definitions||{};let m=(c,h)=>{if(c in this.manifest.definitions){this.trigger("error",{message:`EXT-X-DEFINE: Duplicate name ${c}`});return}this.manifest.definitions[c]=h};if("QUERYPARAM"in _.attributes){if("NAME"in _.attributes||"IMPORT"in _.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}let c=this.params.get(_.attributes.QUERYPARAM);if(!c){this.trigger("error",{message:`EXT-X-DEFINE: No query param ${_.attributes.QUERYPARAM}`});return}m(_.attributes.QUERYPARAM,decodeURIComponent(c));return}if("NAME"in _.attributes){if("IMPORT"in _.attributes){this.trigger("error",{message:"EXT-X-DEFINE: Invalid attributes"});return}if(!("VALUE"in _.attributes)||typeof _.attributes.VALUE!="string"){this.trigger("error",{message:`EXT-X-DEFINE: No value for ${_.attributes.NAME}`});return}m(_.attributes.NAME,_.attributes.VALUE);return}if("IMPORT"in _.attributes){if(!this.mainDefinitions[_.attributes.IMPORT]){this.trigger("error",{message:`EXT-X-DEFINE: No value ${_.attributes.IMPORT} to import, or IMPORT used on main playlist`});return}m(_.attributes.IMPORT,this.mainDefinitions[_.attributes.IMPORT]);return}this.trigger("error",{message:"EXT-X-DEFINE: No attribute"})},"i-frame-playlist"(){this.manifest.iFramePlaylists.push({attributes:_.attributes,uri:_.uri,timeline:p}),this.warnOnMissingAttributes_("#EXT-X-I-FRAME-STREAM-INF",_.attributes,["BANDWIDTH","URI"])}}[_.tagType]||u).call(r)},uri(){i.uri=_.uri,a.push(i),this.manifest.targetDuration&&!("duration"in i)&&(this.trigger("warn",{message:"defaulting segment duration to the target duration"}),i.duration=this.manifest.targetDuration),o&&(i.key=o),i.timeline=p,n&&(i.map=n),y=0,this.lastProgramDateTime!==null&&(i.programDateTime=this.lastProgramDateTime,this.lastProgramDateTime+=i.duration*1e3),i={}},comment(){},custom(){_.segment?(i.custom=i.custom||{},i.custom[_.customType]=_.data):(this.manifest.custom=this.manifest.custom||{},this.manifest.custom[_.customType]=_.data)}})[_.type].call(r)})}requiredCompatibilityversion(t,r){(t<r||!t)&&this.trigger("warn",{message:`manifest must be at least version ${r}`})}warnOnMissingAttributes_(t,r,a){let i=[];a.forEach(function(n){r.hasOwnProperty(n)||i.push(n)}),i.length&&this.trigger("warn",{message:`${t} lacks required attribute(s): ${i.join(", ")}`})}push(t){this.lineStream.push(t)}end(){this.lineStream.push(`
`),this.manifest.dateRanges.length&&this.lastProgramDateTime===null&&this.trigger("warn",{message:"A playlist with EXT-X-DATERANGE tag must contain atleast one EXT-X-PROGRAM-DATE-TIME tag"}),this.lastProgramDateTime=null,this.trigger("end")}addParser(t){this.parseStream.addParser(t)}addTagMapper(t){this.parseStream.addTagMapper(t)}};var Co=new Error("timeout while waiting for mutex to become available"),ko=new Error("mutex already locked"),fr=new Error("request for lock canceled"),cr=function(e,t,r,a){function i(n){return n instanceof r?n:new r(function(o){o(n)})}return new(r||(r=Promise))(function(n,o){function s(d){try{l(a.next(d))}catch(p){o(p)}}function u(d){try{l(a.throw(d))}catch(p){o(p)}}function l(d){d.done?n(d.value):i(d.value).then(s,u)}l((a=a.apply(e,t||[])).next())})},De=class{constructor(t,r=fr){this._value=t,this._cancelError=r,this._queue=[],this._weightedWaiters=[]}acquire(t=1,r=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return new Promise((a,i)=>{let n={resolve:a,reject:i,weight:t,priority:r},o=pt(this._queue,s=>r<=s.priority);o===-1&&t<=this._value?this._dispatchItem(n):this._queue.splice(o+1,0,n)})}runExclusive(t){return cr(this,arguments,void 0,function*(r,a=1,i=0){let[n,o]=yield this.acquire(a,i);try{return yield r(n)}finally{o()}})}waitForUnlock(t=1,r=0){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);return this._couldLockImmediately(t,r)?Promise.resolve():new Promise(a=>{this._weightedWaiters[t-1]||(this._weightedWaiters[t-1]=[]),mr(this._weightedWaiters[t-1],{resolve:a,priority:r})})}isLocked(){return this._value<=0}getValue(){return this._value}setValue(t){this._value=t,this._dispatchQueue()}release(t=1){if(t<=0)throw new Error(`invalid weight ${t}: must be positive`);this._value+=t,this._dispatchQueue()}cancel(){this._queue.forEach(t=>t.reject(this._cancelError)),this._queue=[]}_dispatchQueue(){for(this._drainUnlockWaiters();this._queue.length>0&&this._queue[0].weight<=this._value;)this._dispatchItem(this._queue.shift()),this._drainUnlockWaiters()}_dispatchItem(t){let r=this._value;this._value-=t.weight,t.resolve([r,this._newReleaser(t.weight)])}_newReleaser(t){let r=!1;return()=>{r||(r=!0,this.release(t))}}_drainUnlockWaiters(){if(this._queue.length===0)for(let t=this._value;t>0;t--){let r=this._weightedWaiters[t-1];r&&(r.forEach(a=>a.resolve()),this._weightedWaiters[t-1]=[])}else{let t=this._queue[0].priority;for(let r=this._value;r>0;r--){let a=this._weightedWaiters[r-1];if(!a)continue;let i=a.findIndex(n=>n.priority<=t);(i===-1?a:a.splice(0,i)).forEach((n=>n.resolve()))}}}_couldLockImmediately(t,r){return(this._queue.length===0||this._queue[0].priority<r)&&t<=this._value}};function mr(e,t){let r=pt(e,a=>t.priority<=a.priority);e.splice(r+1,0,t)}function pt(e,t){for(let r=e.length-1;r>=0;r--)if(t(e[r]))return r;return-1}function U(e,t){let r=BigInt(t)<<BigInt(32)|BigInt(e);return BigInt(r)}function Pe(e){let t=Number(e&0xFFFFFFFFn),r=Number(e>>32n);return{lo:t,hi:r}}function At(e){let t,r;return e.av.audio&&e.av.audio.packets.length&&(t=e.av.audio.packets[0]),e.av.video&&e.av.video.packets.length&&(r=e.av.video.packets[0]),!t||!r?!1:gt(t,r)}function ht(e,t){let r,a;return e.av.audio&&e.av.audio.packets.length&&(r=e.av.audio.packets[0]),t.av.video&&t.av.video.packets.length&&(a=t.av.video.packets[0]),!r||!a?!1:gt(r,a)}function gt(e,t){if(!e.time_base_num||!e.time_base_den||!t.time_base_num||!t.time_base_den)return!1;let r=U(e.pts,e.ptshi),a=U(e.duration,e.durationhi),i=U(t.pts,t.ptshi),n=U(t.duration,t.durationhi);if(a==0n||n==0n)return!1;let o=250000000n,s=1000000000n,u=r*BigInt(e.time_base_num)*s/BigInt(e.time_base_den),l=i*BigInt(t.time_base_num)*s/BigInt(t.time_base_den),d=u-l;return(d<0?-d:d)>o}function ue(e){let t=e[0];if(U(t.pts,t.ptshi)==0n)return Z(e);let a=0n,i=0n;t.dts=0,t.dtshi=0,t.pts=0,t.ptshi=0;let n=U(t.duration,t.durationhi);for(let o=1;o<e.length;++o){let s=e[o],u=a+n,l=i+n;a=u,i=l,n=U(s.duration,s.durationhi);let{lo:d,hi:p}=Pe(u),{lo:f,hi:y}=Pe(l);s.dts=d,s.dtshi=p,s.pts=f,s.ptshi=y}return{last_dts:a,last_pts:i,last_duration:n,force_recompute_timings:!0}}function Z(e){let t=e.length-1,r=e[t].dts,a=e[t].dtshi||0,i=U(r,a),n=e[t].pts,o=e[t].ptshi||0,s=U(n,o),u=U(e[t].duration,e[t].durationhi);return{last_dts:i,last_pts:s,last_duration:u}}function de(e,t){let{last_dts:r,last_pts:a,last_duration:i}=t,n=e[0],o=U(n.dts,n.dtshi||0),s=U(n.pts,n.ptshi||0);if(!t.force_recompute_timings&&o>r&&s>a||i==0n)return Z(e);for(let u of e){let l=r+i,d=a+i;r=l,a=d,i=U(u.duration,u.durationhi);let{lo:p,hi:f}=Pe(l),{lo:y,hi:A}=Pe(d);u.dts=p,u.dtshi=f,u.pts=y,u.ptshi=A}return{last_dts:r,last_pts:a,last_duration:i,force_recompute_timings:t.force_recompute_timings}}async function yt(e,t,r){if(r.length!==16)throw new Error("IV must be 16 bytes (128 bits).");if(t.length!==16)throw new Error("Key must be 16 bytes (128 bits).");try{let a=await crypto.subtle.importKey("raw",t,{name:"AES-CBC"},!1,["decrypt"]),i=await crypto.subtle.decrypt({name:"AES-CBC",iv:r},a,e);return S(new Uint8Array(i))}catch{return v({type:"decryption_failed"})}}var Ie=class{constructor(){this.map=new Map}getInitKey(t){return t.byte_range?`${t.url}-${t.byte_range.offset}-${t.byte_range.length}`:`${t.url}`}has(t){return this.map.has(this.getInitKey(t))}set(t,r){return this.map.set(this.getInitKey(t),r)}get(t){return this.map.get(this.getInitKey(t))}};var Et=3e4;async function ee(...e){let t;try{t=await fetch(...e)}catch(r){return r instanceof DOMException&&r.name=="AbortError"?v(ae()):v(P(r.toString()))}return t.status>=400&&t.status<=599?v(Se(t.status)):t.ok?t.body!=null?S(t):v(P("No body")):v(P(`Unkown failure - status ${t.status}`))}async function ne(e){try{let t=new Promise(a=>setTimeout(()=>a(v(P("Timeout"))),Et)),r=e.read().then(a=>S(a));return await Promise.race([t,r])}catch(t){return t instanceof DOMException&&t.name=="AbortError"?v(ae()):v(P(t.toString()))}}async function wt(e){try{let t=new Promise(a=>setTimeout(()=>a(v(P("Timeout"))),Et)),r=e.text().then(a=>S(a));return await Promise.race([t,r])}catch(t){return t instanceof DOMException&&t.name=="AbortError"?v(ae()):v(P(t.toString()))}}var B={Audio:0,Video:1};var Ar=["loom.com"];function bt(e){return Ar.some(t=>e.href.includes(t))}var hr=["mp4","webm","mkv"],gr=["mp3","m4a","ogg"],yr=[...hr,...gr];function vt(e){let t=new Date(new Date().getTime()-6e5);return!e.dateTimeObject&&!e.programDateTime?!1:typeof e.dateTimeObject=="object"?e.dateTimeObject>t:typeof e.programDateTime=="number"?e.programDateTime>t.getTime():!1}var br=.35,xe=5,vr=1500,Tr=500,Sr=4,Dt=5,re=new H,g=await _e.LibAV({noworker:!0});g.onwrite=re.onwrite.bind(re);async function te(e){await g.avformat_close_input_js(e.fmt_ctx),await g.av_packet_free_js(e.pkt),await g.unlink(e.filename_tmp)}async function je(e,t,r){let a=new Headers(t.headers);r&&a.set("Range",`bytes=${r.offset}-${r.offset+r.length-1}`);let i=await ee(e,{headers:a,signal:t.signal});if(i.isErr())return i;t.known_segments_url.add(e);let n=i.value,o=new Uint8Array;{let s=n.body.getReader();for(;;){let u=await ne(s);if(u.isErr())return u;let{done:l,value:d}=u.value;if(l)break;let p=o.length;o=new Uint8Array(o.buffer.transfer(o.length+d.length)),o.set(d,p),t.progress_tracker?.add_bytes(d.length)}}return S(new Uint8Array(o))}async function Tt(e,t,r,a,i){if(!a.has(t)){let o=await je(t,i,void 0);if(o.isErr())return o;a.set(t,o.value)}let n=await yt(e,a.get(t),r);return S(n)}async function Vr(e,t){let r=await je(e.url,t.fetch_args,e.byte_range);if(r.isErr())return r;let a=r.value;if(e.encryption?.url){let n=await Tt(a,e.encryption.url,e.encryption.iv,t.keys,t.fetch_args);if(n.isErr()||n.value.isErr())return n;a=n.value.value}if(!e.init)return S(S(a));if(!t.inits.has(e.init)){let n=await je(e.init.url,t.fetch_args,e.init.byte_range);if(n.isErr())return n;let o=n.value;if(e.init.encryption){let s=await Tt(o,e.init.encryption.url,e.init.encryption.iv,t.keys,t.fetch_args);if(s.isErr()||s.value.isErr())return s;o=s.value.value}t.inits.set(e.init,new Uint8Array(o))}let i=new Uint8Array([...t.inits.get(e.init),...a]);return S(S(i))}async function Re(e,t,r,a){return e.semaphore.runExclusive(()=>fe(t,e,a,!1),1,r)}function Dr(e){let t=[137,80,78,71,13,10,26,10],r=[73,69,78,68,174,66,96,130];for(let o=0;o<t.length;o++)if(e[o]!==t[o])return-1;let a=r.length,i=e.length;if(a===0||a>i)return-1;let n=r[0];for(let o=t.length;o<=i-a;o++){if(e[o]!==n)continue;let s=!0;for(let u=1;u<a;u++)if(e[o+u]!==r[u]){s=!1;break}if(s)return o}return-1}async function St(e,t,r){try{let a=await Vr(e,t);if(a.isErr())return a;if(a.value.isErr())return S(v(a.value.error));let i=a.value.value,n=Dr(i);n>=0&&(i=i.subarray(n,i.length));let o=`${crypto.randomUUID()}.tmp`;await g.writeFile(o,i);let[s,u]=await g.ff_init_demuxer_file(o),l=u.find(E=>E.codec_type===g.AVMEDIA_TYPE_VIDEO);if(!l&&r==B.Video)return S(v({type:"bad_segment"}));let d=u.find(E=>E.codec_type===g.AVMEDIA_TYPE_AUDIO);if(!d&&r==B.Audio)return S(v({type:"bad_segment"}));let p=await g.av_packet_alloc(),[f,y]=await g.ff_read_frame_multi(s,p);if(f!==g.AVERROR_EOF)return S(v({type:"bad_segment"}));let A,_;if(d){_=y[d.index];for(let E of _)E.stream_index=0}if(l){A=y[l.index];for(let E of A)d||t.expect_two_streams?E.stream_index=1:E.stream_index=0}let w;return d&&l?w={video:{stream:l,packets:A},audio:{stream:d,packets:_}}:l?w={video:{stream:l,packets:A},audio:!1}:w={video:!1,audio:{stream:d,packets:_}},S(S({av:w,pkt:p,fmt_ctx:s,filename_tmp:o,is_live:e.is_live}))}catch{return S(v({type:"bad_segment"}))}}function Vt(e){if("byterange"in e&&"length"in e.byterange&&"offset"in e.byterange){let r=e.byterange,a=r.offset,i=r.length;return{offset:a,length:i}}}function Pr(e){let t=new Uint8Array(16);return new DataView(t.buffer).setUint32(12,e,!1),t}function Ir(e){let t=new Uint8Array(e.length*4);for(let r=0;r<e.length;r++){let a=e[r],i=r*4;t[i+0]=a>>>24&255,t[i+1]=a>>>16&255,t[i+2]=a>>>8&255,t[i+3]=a&255}return t}async function q(e,t,r){let a=v(P(""));for(let u=0;u<Dt&&(a=await ee(e,{headers:t,signal:r}),!a.isOk());++u)if(a.error.user_abort)break;if(a.isErr())return a;let i=await wt(a.value);if(i.isErr())return i;let n=null;try{let u=new Ee;u.push(i.value),u.end(),n=u.manifest}catch{}let o=n.mediaSequence;!n&&Array.isArray(n.segments)&&F("Parsing error");let s=n.segments.map(u=>{let l=u.uri,d=vt(u),p=new URL(l,e);bt(p)&&e.search&&(p.search=e.search);let f={url:p.href,is_live:d,sequence_number:o};if(typeof u.duration=="number"&&(f.duration_s=u.duration),u.key?.method=="AES-128"){let _=u.key?.uri,w;!u.key.iv&&(!u.attributes?.KEYFORMAT||u.attributes.KEYFORMAT=="identity")?w=Pr(o):w=Ir(u.key.iv),f.encryption={url:new URL(_,e).href,iv:w}}let y=Vt(u);y&&(f.byte_range=y);let A=u.map;if(A&&"uri"in A){let _=A.uri,w=new URL(_,e).href;if(f.init={url:w},u.map.key?.method=="AES-128"){let m=u.map.key.uri,c=u.map.key.iv;c=new Uint8Array(c.buffer),f.init.encryption={url:new URL(m,e).href,iv:c}}let E=Vt(A);E&&(f.init.byte_range=E)}return o++,f});return S(s)}async function Je(e,t,r){let a=await g.av_write_trailer(e);if(a!=0){let i=await g.strerror(a);return v(i)}return await g.ff_free_muxer(e,t),await re.close(r),await g.unlink(r),S(r)}async function Qe(e,t,r,a){if(e.isErr()||e.value=="skip"||!e.value.is_live)return!1;let i=await a();return i.isErr()?!1:i.value==!0?(t.progress_tracker?.dont_trust_percent(),r.value=xe,!0):r.value>0?(r.value--,await new Promise(n=>setTimeout(n,vr)),!0):!1}async function fe(e,t,r,a){let i=await St(e,t,r);for(let o=0;o<Dt-1&&!(i.isOk()||i.error.user_abort);o++)await new Promise(s=>setTimeout(s,Tr*o)),i=await St(e,t,r);if(i.isErr())return i;if(i.value.isOk())return e.duration_s&&(t.duration_s+=e.duration_s,t.fetch_args.progress_tracker?.set_duration_in_s(t.duration_s)),S(i.value.value);let n=i.value.error;if(n.type=="bad_segment")return t.failures.count++,a?v(P("Required segment was invalid, aborting download.")):t.failures.count/t.total_segments>br?v(P("Too many invalid segments, aborting download.")):S("skip");if(n.type=="decryption_failed")return v(P("Decryption failed."));n.type,F("unreachable")}async function Pt(e,t){let r=await q(e.url,e.headers,t);if(r.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:r.error};let a=r.value,i=a[0];i||F("Video Media Manifest does not contain video URLs");let n=Me(e,t,a.length,!1);await re.open(n.output_filename);let o=i.is_live,s;o?s=a.length-1:s=Math.floor(a.length/2);let u=await fe(a[s],n,B.Video,!0);if(u.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:u.error};u.value=="skip"&&F("Can't skip segment early");let l=u.value;l.av.video||F("No video for preview");let d=[];if(l.av.audio){let w=l.av.audio.stream;d.push([w.codecpar,w.time_base_num,w.time_base_den])}if(l.av.video){let w=l.av.video.stream;d.push([w.codecpar,w.time_base_num,w.time_base_den])}else F("No video for preview");let p={filename:n.output_filename,open:!0,codecpars:!0,device:!0},[f,,y]=await g.ff_init_muxer(p,d),A=await g.av_opt_set(f,"avoid_negative_ts","make_zero",0);Ae(g,A),A=await g.avformat_write_header(f,0),pe(g,A),await g.ff_write_multi(f,l.pkt,l.av.video.packets),l.av.audio&&await g.ff_write_multi(f,l.pkt,l.av.audio.packets),await te(l);let _=await Je(f,y,n.output_filename);return _.isErr()&&F(_.error),{aborted_no_partial:!1,internal_filename:_.value,internal_bloburl:void 0,download_id:e.download_id,ending_reason:"end_of_file"}}function Me(e,t,r,a){let i=e.throttle?1:Sr;return{semaphore:new De(i),inits:new Ie,keys:new Map,fetch_args:{signal:t,headers:e.headers,known_segments_url:new Set,progress_tracker:new Y(e.download_id)},failures:{count:0},muxer:e.muxer,output_filename:`${e.download_id}.${e.extension}`,expect_two_streams:a,total_segments:r,duration_s:0}}async function It(e,t){let r=await q(e.url,e.headers,t);if(r.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:r.error};let a=r.value;a.length==0&&F("Video Media Manifest does not contain video URLs");let i=await q(e.url_audio,e.headers,t);if(i.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:i.error};let n=i.value;n.length==0&&F("Media Manifest does not contain audio URLs");let o=Me(e,t,a.length+n.length,!0);await re.open(o.output_filename);let s=await fe(a[0],o,B.Video,!0),u=await fe(n[0],o,B.Audio,!0);if(s.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:s.error};let l=s.value;if(l=="skip")return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("First segment was invalid and skipped, aborting.")};if(u.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:u.error};let d=u.value;if(d=="skip")return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("First segment was invalid and skipped, aborting.")};a.shift(),n.shift();let p=[];if(d.av.audio){let b=d.av.audio.stream;p.push([b.codecpar,b.time_base_num,b.time_base_den])}if(l.av.video){let b=l.av.video.stream;p.push([b.codecpar,b.time_base_num,b.time_base_den])}let f=e.muxer=="mkv"?"matroska":e.muxer,y={filename:o.output_filename,open:!0,codecpars:!0,device:!0,format_name:f},[A,,_]=await g.ff_init_muxer(y,p),w=await g.av_opt_set(A,"avoid_negative_ts","make_zero",0);Ae(g,w),w=await g.avformat_write_header(A,0),pe(g,w);let E=ht(d,l),m;l.av.video&&(m=E?ue(l.av.video.packets):Z(l.av.video.packets),await g.ff_write_multi(A,l.pkt,l.av.video.packets));let c;d.av.audio&&(c=E?ue(d.av.audio.packets):Z(d.av.audio.packets),await g.ff_write_multi(A,d.pkt,d.av.audio.packets)),await te(l),await te(d);let h=v(P("not started")),x={value:xe},T=!1;for(;;){let b=[],L=Math.max(a.length,n.length);for(let M=0;M<L;M++){let I=L-M;if(M<a.length){let oe=Re(o,a[M],I,B.Video);b.push(oe)}if(M<n.length){let oe=Re(o,n[M],I,B.Audio);b.push(oe)}}let $=-1;for(;b.length>0&&($++,h=await b.shift(),!h.isErr());){if(h.value=="skip")continue;let I=h.value;I.av.video?(m=de(I.av.video.packets,m),await g.ff_write_multi(A,I.pkt,I.av.video.packets)):I.av.audio&&(c=de(I.av.audio.packets,c),await g.ff_write_multi(A,I.pkt,I.av.audio.packets)),o.fetch_args.progress_tracker?.set_percent(100*($/o.total_segments)),await te(I)}if(T=await Qe(h,o.fetch_args,x,async()=>{let M=await q(e.url,e.headers,t);if(M.isErr())return M;let I=await q(e.url_audio,e.headers,t);if(I.isErr())return I;a=M.value.filter(({url:ce})=>!o.fetch_args.known_segments_url.has(ce)),n=I.value.filter(({url:ce})=>!o.fetch_args.known_segments_url.has(ce));let oe=a.length>0||n.length>0;return S(oe)}),!T)break}let V=await Je(A,_,o.output_filename);return V.isErr()&&F(V.error),{aborted_no_partial:!1,internal_filename:V.value,internal_bloburl:await N(e,V.value),download_id:e.download_id,ending_reason:h.isOk()?"end_of_file":h.error}}async function Rt(e,t){let r=await q(e.url,e.headers,t);if(r.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:r.error};let a=r.value;a.length==0&&F("Video Media Manifest does not contain video URLs");let i=Me(e,t,a.length,!1);await re.open(i.output_filename);let n=await fe(a[0],i,B.Video,!0);if(n.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:n.error};let o=n.value;if(o=="skip")return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("First segment was invalid and skipped, aborting.")};a.shift();let s=[];if(o.av.audio){let h=o.av.audio.stream;s.push([h.codecpar,h.time_base_num,h.time_base_den])}if(o.av.video){let h=o.av.video.stream;s.push([h.codecpar,h.time_base_num,h.time_base_den])}let u=e.muxer=="mkv"?"matroska":e.muxer,l={filename:i.output_filename,open:!0,codecpars:!0,device:!0,format_name:u},[d,,p]=await g.ff_init_muxer(l,s),f=await g.av_opt_set(d,"avoid_negative_ts","make_zero",0);Ae(g,f),f=await g.avformat_write_header(d,0),pe(g,f);let y=At(o),A;o.av.video&&(A=y?ue(o.av.video.packets):Z(o.av.video.packets),await g.ff_write_multi(d,o.pkt,o.av.video.packets));let _;o.av.audio&&(_=y?ue(o.av.audio.packets):Z(o.av.audio.packets),await g.ff_write_multi(d,o.pkt,o.av.audio.packets)),await te(o);let w=v(P("not started")),E={value:xe},m=!1;for(;;){let h=[];for(let T=0;T<a.length;T++){let V=a.length-T,b=Re(i,a[T],V,B.Video);h.push(b)}let x=-1;for(;h.length>0&&(x++,w=await h.shift(),!w.isErr());){if(w.value=="skip")continue;let V=w.value;V.av.video&&(A=de(V.av.video.packets,A),await g.ff_write_multi(d,V.pkt,V.av.video.packets)),V.av.audio&&(_=de(V.av.audio.packets,_),await g.ff_write_multi(d,V.pkt,V.av.audio.packets)),i.fetch_args.progress_tracker?.set_percent(100*(x/i.total_segments)),await te(V)}if(!w||(m=await Qe(w,i.fetch_args,E,async()=>{let T=await q(e.url,e.headers,t);return T.isErr()?T:(a=T.value.filter(({url:V})=>!i.fetch_args.known_segments_url.has(V)),S(a.length>0))}),!m))break}let c=await Je(d,p,i.output_filename);return c.isErr()&&F(c.error),{aborted_no_partial:!1,internal_filename:c.value,internal_bloburl:await N(e,c.value),download_id:e.download_id,ending_reason:w.isOk()?"end_of_file":w.error}}async function xt(e,t){let i=e.url,n=await q(i,e.headers,t);if(n.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:n.error};let o=n.value;o.length==0&&F("Audio Media Manifest does not contain audio URLs");let s=Me(e,t,o.length,!1),u=await fe(o[0],s,B.Audio,!0);if(u.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:u.error};let l=u.value;if(l=="skip")return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("First segment was invalid and skipped, aborting.")};o.shift();let d;l.av.audio&&(d=ue(l.av.audio.packets)),l.av.audio||F("No audio stream found");let p=l.av.audio.stream,[,f,y,A]=await g.ff_init_decoder(p.codec_id,p.codecpar),_=await g.ff_decode_multi(f,y,A,l.av.audio.packets,{fin:!1}),w="aresample=isf=s16p:osf=fltp,asetnsamples=n=1152:p=0",[E,m,c]=await g.ff_init_filter_graph(w,{sample_rate:_[0].sample_rate,sample_fmt:_[0].format,channel_layout:_[0].channel_layout},{sample_rate:44100,sample_fmt:g.AV_SAMPLE_FMT_FLTP,channel_layout:_[0].channel_layout}),h=await g.ff_filter_multi(m,c,A,_,{fin:!1}),[x,T,V,b,L]=await g.ff_init_encoder("libmp3lame",{ctx:{bit_rate:128e3,sample_fmt:g.AV_SAMPLE_FMT_FLTP,sample_rate:44100,channel_layout:_[0].channel_layout,channels:_[0].channels},time_base:[1,44100]}),$=await g.ff_encode_multi(T,V,b,h,!1);await re.open(s.output_filename);let M={filename:s.output_filename,open:!0,codecpars:!1,device:!0,format_name:"mp3"},[I,oe,ce,[kr]]=await g.ff_init_muxer(M,[[T,1,44100]]),se=await g.av_opt_set(I,"avoid_negative_ts","make_zero",0);Ae(g,se),se=await g.avformat_write_header(I,0),pe(g,se),await g.ff_write_multi(I,b,$),await te(l);let j=v(P("not started")),$t={value:xe},rt=!1;for(;;){let me=[];for(let G=0;G<o.length;G++){let W=o.length-G,Oe=Re(s,o[G],W,B.Audio);me.push(Oe)}let Fe=-1;for(;me.length>0&&(Fe++,j=await me.shift(),!j.isErr());){if(j.value=="skip")continue;let W=j.value;W.av.audio||F(`No audio found in segment ${Fe+1}`),d=de(W.av.audio.packets,d);let Oe=await g.ff_decode_multi(f,y,A,W.av.audio.packets,{fin:!1}),zt=await g.ff_filter_multi(m,c,A,Oe,{fin:!1}),Ht=await g.ff_encode_multi(T,V,b,zt,!1);await g.ff_write_multi(I,W.pkt,Ht),s.fetch_args.progress_tracker?.set_percent(100*(Fe/s.total_segments)),await te(W)}if(!j)break;if(rt=await Qe(j,s.fetch_args,$t,async()=>{let G=await q(i,e.headers,t);return G.isErr()?G:(o=G.value.filter(({url:W})=>!s.fetch_args.known_segments_url.has(W)),S(o.length>0))}),!rt){let G=await g.ff_encode_multi(T,V,b,[],!0);await g.ff_write_multi(I,0,G);break}}if(se=await g.av_write_trailer(I),se!=0){let me=await g.strerror(se);F(me)}return await g.ff_free_decoder(f,y,A),await g.avfilter_graph_free_js(E),await g.ff_free_encoder(T,V,b),await g.ff_free_muxer(I,ce),await re.close(s.output_filename),await g.unlink(s.output_filename),{internal_filename:s.output_filename,aborted_no_partial:!1,internal_bloburl:await N(e,s.output_filename),download_id:e.download_id,ending_reason:j.isOk()?"end_of_file":j.error}}async function Mt(e,t){let r=`${e.download_id}.${e.muxer}`;return await X(e,t,r,["-seg_max_retry","3","-max_reload","5","-analyzeduration","10M","-f","hls","-i",`jsfetch:${e.url}`,"-c:a","libmp3lame","-avoid_negative_ts","make_zero","-y",r])}async function Ft(e,t){let r=`${e.download_id}.${e.muxer}`;return await X(e,t,r,["-seg_max_retry","3","-max_reload","5","-analyzeduration","10M","-f","hls","-i",`jsfetch:${e.url}`,"-c","copy","-avoid_negative_ts","make_zero","-y",r])}async function Ot(e,t){let r=`${e.download_id}.${e.muxer}`;return await X(e,t,r,["-seg_max_retry","3","-max_reload","5","-analyzeduration","10M","-f","hls","-i",`jsfetch:${e.url}`,"-i",`jsfetch:${e.url_audio}`,"-c","copy","-map","0:v:0","-map","1:a:0?","-avoid_negative_ts","make_zero","-y",r])}function Ct(e){if(!e.headers.get("content-length"))return O;let t=e.headers.get("content-length"),r=parseInt(t);return r<=0?O:k(r)}async function kt(e,t){let r=`${e.download_id}.${e.muxer}`;return X(e,t,r,["-analyzeduration","1M","-ss","0","-i",`jsfetch:${e.url}`,"-t","5","-c","copy","-avoid_negative_ts","make_zero","-y",r])}async function Nt(e,t){let r=`${e.download_id}.${e.muxer}`;return await X(e,t,r,["-analyzeduration","10M","-i",`jsfetch:${e.url}`,"-c","copy","-avoid_negative_ts","make_zero","-y",r])}async function Lt(e,t){let r=`${e.download_id}.${e.muxer}`;try{return await X(e,t,r,["-analyzeduration","10M","-i",`jsfetch:${e.url}`,"-map","0:a:0","-af","aresample","-c:a","libmp3lame","-avoid_negative_ts","make_zero","-y",r])}catch(a){return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:{user_abort:!1,percentage_incomplete:!1,e4XX_5XX_failure:!1,other_failure:!0,message:`Failed to download audio http media ${a}`}}}}async function we(e,t,r,a,i,{headers:n,download_id:o}){let s=await ee(a,{headers:n,signal:i});if(s.isErr())return{aborted_no_partial:!0,download_id:o,ending_reason:s.error};let u=s.value.body.getReader(),l=Ct(s.value),d;l.isSome()&&(d=l.value);let p=0;for(;;){let f=await ne(u);if(f.isErr())return{aborted_no_partial:!0,download_id:o,ending_reason:f.error};let{done:y,value:A}=f.value;if(y)break;e.onwrite(t,p,A),p+=A.length,d?r.set_progress({percent:{is_known:!0,value:100*(p/d)},fetched_bytes_count:p,status:"downloading",output_duration_s:0}):r.set_progress({percent:{is_known:!1},fetched_bytes_count:p,status:"downloading",output_duration_s:0})}return{aborted_no_partial:!1,download_id:o,ending_reason:"end_of_file",internal_filename:t,internal_bloburl:void 0}}async function Ut(e,t){let r=`${e.download_id}.${e.extension}`,a=new H;await a.open(r);let i=new Y(e.download_id),n=await we(a,r,i,e.url,t,e);return await a.close(r),n.aborted_no_partial?a.remove(r):n.internal_bloburl=await N(e,r),n}var Xt=1048576*10,R=new H,Ze=await _e.LibAV({noworker:!0});Ze.onwrite=R.onwrite.bind(R);async function et(e,t,r,a,i,{headers:n,download_id:o},s){let u=s,l=0,d=0;for(;!(l>=u);){let p=Math.min(l+Xt,u),f=`${a.href}&range=${l}-${p}`;l=p+1;let y=await ee(f,{headers:n,signal:i});if(y.isErr())return{aborted_no_partial:!0,download_id:o,ending_reason:y.error};let A=y.value.body.getReader();for(;;){let _=await ne(A);if(_.isErr())return{aborted_no_partial:!0,download_id:o,ending_reason:_.error};let{done:w,value:E}=_.value;if(w)break;e.onwrite(t,d,E),d+=E.length,r.set_progress({percent:{is_known:!0,value:100*(d/u)},fetched_bytes_count:d,status:"downloading",output_duration_s:0})}}return{aborted_no_partial:!1,download_id:o,ending_reason:"end_of_file",internal_filename:t,internal_bloburl:void 0}}async function tt(e,t){let r=new Y(e.download_id),a=`${e.good_basename}.${e.extension}`;await R.open(a);let i;return e.content_length.isSome()?i=await et(R,a,r,e.url,t,e,e.content_length.value):i=await we(R,a,r,e.url,t,e),await R.close(a),i.aborted_no_partial?R.remove(a):i.internal_bloburl=await N(e,a),i}async function Bt(e,t){let r=new Te(e.download_id),a;{a=`${e.download_id}_audio`,await R.open(a);let y;if(e.audio_content_length.isSome()?y=await et(R,a,r,e.url_audio,t,e,e.audio_content_length.value):y=await we(R,a,r,e.url_audio,t,e),await R.close(a),y.aborted_no_partial)return R.remove(a),y}r.nextStream();let i;{i=`${e.download_id}_video`,await R.open(i);let y;if(e.content_length.isSome()?y=await et(R,i,r,e.url,t,e,e.content_length.value):y=await we(R,i,r,e.url,t,e),await R.close(i),y.aborted_no_partial)return R.remove(i),y}let n=await navigator.storage.getDirectory(),o=await n.getFileHandle(a),s=await n.getFileHandle(i),u=await o.getFile(),l=await s.getFile(),d=URL.createObjectURL(u),p=URL.createObjectURL(l),f=`${e.download_id}.${e.extension}`;await Ze.mkwriterdev(f),await R.open(f);try{let y=await Ze.ffmpeg("-i",`jsfetch:${d}`,"-i",`jsfetch:${p}`,"-c","copy","-y",f);return await R.close(f),URL.revokeObjectURL(d),URL.revokeObjectURL(p),await n.removeEntry(a),await n.removeEntry(i),y==0?{aborted_no_partial:!1,internal_filename:f,internal_bloburl:await N(e,f),download_id:e.download_id,ending_reason:"end_of_file"}:{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P("muxing failed")}}catch(y){try{R.remove(f),URL.revokeObjectURL(d),URL.revokeObjectURL(p),n.removeEntry(a),n.removeEntry(i)}catch{}return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:P(y.toString())}}}async function Gt(e,t){let r=`${e.download_id}.${e.extension}`,a=`${e.url.href}&range=0-${Xt}`,i=0;await R.open(r);let n=await ee(a,{headers:e.headers,signal:t});if(n.isErr())return{aborted_no_partial:!0,download_id:e.download_id,ending_reason:n.error};let o=n.value.body.getReader();try{for(;;){let s=await ne(o);if(s.isErr())return R.close(r),R.remove(r),{aborted_no_partial:!0,download_id:e.download_id,ending_reason:s.error};let{done:u,value:l}=s.value;if(u)break;R.onwrite(r,i,l),i+=l.length}return R.close(r),{aborted_no_partial:!1,internal_filename:r,internal_bloburl:void 0,download_id:e.download_id,ending_reason:"end_of_file"}}catch(s){throw R.close(r),R.remove(r),s}}async function Yt(e,t){return await tt(e,t)}async function Or(e,t){try{let r;if(e.strategy=="m3u8_audio_only")r=e.will_use_jsfetch?await Mt(e,t):await xt(e,t);else if(e.strategy=="m3u8_audio_video_one_source")r=e.will_use_jsfetch?await Ft(e,t):await Rt(e,t);else if(e.strategy=="m3u8_audio_video_two_sources")r=e.will_use_jsfetch?await Ot(e,t):await It(e,t);else if(e.strategy=="m3u8_video_preview")r=await Pt(e,t);else if(e.strategy=="youtube_audio_only")r=await Yt(e,t);else if(e.strategy=="youtube_audio_video_one_source")r=await tt(e,t);else if(e.strategy=="youtube_audio_video_two_sources")r=await Bt(e,t);else if(e.strategy=="youtube_video_preview")r=await Gt(e,t);else if(e.strategy=="http_audio_video_one_source")r=await Ut(e,t);else if(e.strategy=="http_audio_video_one_source_jsfetch")r=await Nt(e,t);else if(e.strategy=="http_strip_audio_jsfetch")r=await Lt(e,t);else if(e.strategy=="http_video_preview_jsfetch")r=await kt(e,t);else if(e.strategy=="mpd_audio_only")r=await ut(e,t);else if(e.strategy=="mpd_audio_video_one_source")r=await lt(e,t);else if(e.strategy=="mpd_video_preview")r=await dt(e,t);else throw new Error("Unreachable");K({name:"download_result",data:r})}catch(r){let a=ot(r);throw K({name:"download_error",data:{download_id:e.download_id,error:a}}),r}}function Cr(){let e=new Map;st(async t=>{if(t.name=="abort_download"){let r=e.get(t.data.download_id);r&&r.abort()}else if(t.name=="download"){let r=z(t.data.download_args),a=new AbortController;e.set(r.download_id,a),await Or(r,a.signal),e.delete(r.download_id),a.abort(),K({name:"download_progress",data:{download_id:r.download_id,progress:{status:"finalizing"}}})}else t.name=="revoke_blob_url"?URL.revokeObjectURL(t.data.blob_url):t.name=="is_ready"&&K({name:"is_ready_success",data:null})}),K({name:"is_ready_success",data:null})}Cr();export{Or as Download};
/*! Bundled license information:

m3u8-parser/dist/m3u8-parser.es.js:
  (*! @name m3u8-parser @version 7.2.0 @license Apache-2.0 *)
*/
